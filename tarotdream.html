<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¡”ç¾…ç‰Œç¾©æŸ¥è©¢èˆ‡å…¨æ–¹ä½å åœ</title>
    <style>
        :root {
            --primary: #2c3e50;
            --accent: #6c5ce7;
            --bg: #dfe6e9;
            --card-bg: #fff;
            --rev-color: #c0392b;
            --delete-color: #e74c3c;
        }

        body { font-family: "Microsoft JhengHei", sans-serif; background: var(--bg); margin: 0; padding: 20px; color: #333; padding-bottom: 80px; }
        
        header { text-align: center; margin-bottom: 30px; position: relative; }
        h1 { color: var(--primary); margin-bottom: 5px; }
        p { color: #636e72; }

        /* --- é ‚éƒ¨æŒ‰éˆ•å€ --- */
        .top-actions { position: absolute; top: 0; right: 0; }
        .icon-btn { background: none; border: none; font-size: 1.5rem; cursor: pointer; padding: 5px; transition: 0.3s; }
        .icon-btn:hover { transform: scale(1.1); }

        /* --- æ¨¡å¼åˆ‡æ›æŒ‰éˆ• --- */
        .mode-selector { display: flex; justify-content: center; gap: 10px; margin-bottom: 25px; flex-wrap: wrap; }
        .mode-btn {
            padding: 10px 20px; border: none; border-radius: 25px; font-size: 16px; cursor: pointer;
            background: #fff; color: var(--primary); box-shadow: 0 2px 5px rgba(0,0,0,0.1); transition: 0.3s;
        }
        .mode-btn.active, .mode-btn:hover { background: var(--accent); color: white; }

        /* --- æ§ä»¶å€åŸŸ --- */
        .controls { max-width: 800px; margin: 0 auto 30px; text-align: center; }
        
        input, select {
            width: 100%; padding: 15px; border: 2px solid #b2bec3; border-radius: 30px; 
            font-size: 16px; outline: none; box-sizing: border-box; margin-bottom: 15px;
            transition: 0.3s; background: #fff;
        }
        input:focus, select:focus { border-color: var(--accent); box-shadow: 0 0 10px rgba(108, 92, 231, 0.2); }

        .filter-buttons { display: flex; flex-wrap: wrap; justify-content: center; gap: 8px; }
        .filter-btn {
            background: #fff; border: 1px solid #b2bec3; padding: 8px 16px; 
            border-radius: 20px; cursor: pointer; transition: 0.2s; font-weight: bold; color: #636e72;
        }
        .filter-btn:hover, .filter-btn.active { background: var(--accent); color: white; border-color: var(--accent); }

        /* --- ç‰Œé™£èªªæ˜å€å¡Š --- */
        .spread-info {
            background: #eccc68; color: #2f3542; padding: 15px; border-radius: 10px;
            margin-bottom: 20px; text-align: left; font-size: 0.95em; line-height: 1.6;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        /* --- å¡ç‰‡ç¶²æ ¼ --- */
        .grid {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); 
            gap: 25px; max-width: 1200px; margin: 0 auto;
        }

        .card {
            background: var(--card-bg); border-radius: 15px; overflow: hidden;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1); transition: transform 0.2s;
            display: flex; flex-direction: column; position: relative;
            perspective: 1000px;
        }

        /* å¡ç‰‡ä¸Šçš„åˆªé™¤æŒ‰éˆ• (è‡ªç”±æŠ½ç‰Œç”¨) */
        .card-delete-btn {
            position: absolute; top: 10px; left: 10px; z-index: 10;
            background: var(--delete-color); color: white; border: none;
            width: 30px; height: 30px; border-radius: 50%; cursor: pointer;
            display: flex; align-items: center; justify-content: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3); font-size: 14px;
            transition: 0.2s;
        }
        .card-delete-btn:hover { transform: scale(1.1); background: #c0392b; }
        
        /* --- å¯¦é«”æŠ½ç‰Œç©ºç™½å¡æ§½ --- */
        .card.empty-slot {
            height: 400px; border: 3px dashed #b2bec3; background: #f1f2f6;
            align-items: center; justify-content: center; cursor: pointer;
            transition: 0.3s; color: #636e72;
        }
        .card.empty-slot:hover {
            border-color: var(--accent); background: #fff; color: var(--accent);
        }
        .empty-icon { font-size: 3rem; margin-bottom: 10px; }
        
        /* --- ç¿»ç‰Œå‹•ç•«çµæ§‹ --- */
        .card-inner {
            position: relative; width: 100%; height: 350px; 
            transition: transform 0.8s; transform-style: preserve-3d;
        }
        .card.flipped .card-inner { transform: rotateY(180deg); }
        .card.no-anim .card-inner { transform: rotateY(180deg); transition: none; }

        .card-front, .card-back {
            position: absolute; width: 100%; height: 100%;
            -webkit-backface-visibility: hidden; backface-visibility: hidden;
            top: 0; left: 0;
        }

        .card-back {
            background: linear-gradient(135deg, #2c3e50 25%, transparent 25%) -50px 0,
                        linear-gradient(225deg, #2c3e50 25%, transparent 25%) -50px 0,
                        linear-gradient(315deg, #2c3e50 25%, transparent 25%),
                        linear-gradient(45deg, #2c3e50 25%, transparent 25%);
            background-size: 100px 100px;
            background-color: #34495e;
            display: flex; align-items: center; justify-content: center;
            border-radius: 15px 15px 0 0;
            color: rgba(255,255,255,0.1); font-size: 3rem;
        }

        .card-front {
            transform: rotateY(180deg);
            background: #f1f2f6;
            display: flex; align-items: center; justify-content: center; overflow: hidden;
        }

        .img-container { width: 100%; height: 100%; position: relative; }
        
        .card-img {
            width: 100%; height: 100%;
            object-fit: cover; object-position: center;
            transition: transform 0.5s;
        }

        .card-img.rotated { transform: rotate(180deg); }

        .badge {
            position: absolute; top: 10px; right: 10px; 
            color: white; padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: bold;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3); z-index: 2;
            backdrop-filter: blur(5px);
        }
        
        .major { background: rgba(142, 68, 173, 0.9); } 
        .fire { background: rgba(231, 76, 60, 0.9); }  
        .water { background: rgba(52, 152, 219, 0.9); } 
        .air { background: rgba(241, 196, 15, 0.9); color: #333 !important; } 
        .earth { background: rgba(39, 174, 96, 0.9); } 

        .content { padding: 15px; flex-grow: 1; display: flex; flex-direction: column; background: #fff; z-index: 1;}
        h3 { margin: 0 0 10px; color: var(--primary); font-size: 1.2em; border-bottom: 2px solid #f0f0f0; padding-bottom: 8px; }
        
        .meaning { margin-bottom: 8px; font-size: 0.9em; line-height: 1.5; color: #2d3436; }
        .label { font-weight: bold; display: inline-block; margin-right: 5px; }
        .up { color: #27ae60; }
        .rev { color: var(--rev-color); }
        .highlight { background: #ffeaa7; padding: 0 2px; }

        /* --- å åœæ¨¡å¼å°ˆç”¨ --- */
        .position-title {
            text-align: center; font-weight: bold; color: var(--accent); margin-bottom: 10px; font-size: 1.1em;
            background: #f0f3f5; padding: 5px; border-radius: 5px;
        }
        .reading-status { font-size: 0.8em; margin-left: 5px; }
        
        .btn-group { display: flex; gap: 10px; justify-content: center; margin: 20px 0; }

        .action-btn {
            background: var(--accent); color: white; border: none; padding: 15px 30px;
            border-radius: 30px; font-size: 18px; cursor: pointer; flex: 1; max-width: 300px;
            transition: 0.3s;
        }
        .action-btn:hover { background: #5649c0; box-shadow: 0 5px 15px rgba(108, 92, 231, 0.3); }
        
        .secondary-btn {
            background: #b2bec3; color: #2d3436; border: none; padding: 15px;
            border-radius: 30px; cursor: pointer; transition: 0.3s; font-weight: bold;
        }
        .secondary-btn:hover { background: #636e72; color: white; }
        .ai-btn { background: linear-gradient(45deg, #0984e3, #8e44ad); color: white; }

        /* --- é€šç”¨ Modal --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center;
            z-index: 1000; opacity: 0; pointer-events: none; transition: 0.3s;
        }
        .modal-overlay.open { opacity: 1; pointer-events: auto; }
        .modal {
            background: white; width: 90%; max-width: 600px; max-height: 80vh;
            border-radius: 15px; padding: 20px; overflow-y: auto; position: relative; display: flex; flex-direction: column;
        }
        .close-modal { position: absolute; top: 15px; right: 20px; font-size: 24px; cursor: pointer; }
        
        /* --- æ­·å²ç´€éŒ„æ¨£å¼ (æ–°) --- */
        .history-item { border: 1px solid #eee; padding: 10px; border-radius: 8px; margin-bottom: 10px; background: #f9f9f9; position: relative;}
        .history-header { display: flex; justify-content: space-between; font-weight: bold; color: var(--primary); border-bottom: 1px solid #ddd; padding-bottom: 5px; margin-bottom: 5px; padding-right: 30px;}
        .history-cards { font-size: 0.9em; color: #666; }
        .history-question { font-size: 0.95em; color: #d63031; margin-bottom: 5px; font-weight: bold; }
        
        /* æ­·å²ç´€éŒ„ç¨ç«‹åˆªé™¤æŒ‰éˆ• */
        .history-del-btn {
            position: absolute; top: 10px; right: 10px;
            background: none; border: none; cursor: pointer; font-size: 1.2em; color: #b2bec3;
            transition: 0.2s;
        }
        .history-del-btn:hover { color: var(--delete-color); transform: scale(1.1); }

        /* --- é¸ç‰Œå™¨æ¨£å¼ --- */
        .picker-tabs { display: flex; gap: 5px; margin-bottom: 15px; overflow-x: auto; padding-bottom: 5px; }
        .picker-tab { white-space: nowrap; padding: 8px 12px; border: 1px solid #ddd; border-radius: 20px; cursor: pointer; background: #eee; }
        .picker-tab.active { background: var(--accent); color: white; border-color: var(--accent); }
        
        .picker-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 10px; max-height: 400px; overflow-y: auto; }
        .picker-card { 
            border: 1px solid #eee; border-radius: 8px; padding: 10px; text-align: center; cursor: pointer; transition: 0.2s;
            display: flex; flex-direction: column; align-items: center;
        }
        .picker-card:hover { border-color: var(--accent); background: #f0f3f5; }
        .picker-card span { font-size: 0.9em; margin-top: 5px; }
        .picker-card .sm-badge { font-size: 10px; padding: 2px 6px; border-radius: 4px; color: white; margin-bottom: 5px;}

        .picker-options { margin-top: 20px; border-top: 1px solid #eee; padding-top: 15px; display: flex; align-items: center; justify-content: space-between; }
        .checkbox-wrapper { display: flex; align-items: center; gap: 10px; font-size: 1.1em; cursor: pointer; }
        .checkbox-wrapper input { width: 20px; height: 20px; margin: 0; }

        .hidden { display: none !important; }
        .text-center { text-align: center; }

        @media (max-width: 600px) {
            .grid { grid-template-columns: 1fr; }
            .card-inner { height: 400px; }
            .btn-group { flex-direction: column; align-items: center; }
            .action-btn, .secondary-btn { width: 100%; }
        }

    </style>
</head>
<body>

<header>
    <div class="top-actions">
        <button class="icon-btn" onclick="openHistory()" title="æŸ¥çœ‹æ­·å²ç´€éŒ„">ğŸ“œ</button>
    </div>
    <h1>ğŸ”® å¡”ç¾…ç‰Œç¾©æŸ¥è©¢èˆ‡å…¨æ–¹ä½å åœ Ultimate</h1>
    <p>ç¶“å…¸èŠå¾·å‰ç‰¹å¡”ç¾…ç‰Œ (Rider-Waite)</p>
</header>

<div class="mode-selector">
    <button class="mode-btn active" onclick="switchMode('browse')">ğŸ“– ç€è¦½ç‰Œåº«</button>
    <button class="mode-btn" onclick="switchMode('daily')">ğŸ“… æ¯æ—¥ä¸€æŠ½</button>
    <button class="mode-btn" onclick="switchMode('spread')">ğŸ§™â€â™‚ï¸ ç·šä¸Šç‰Œé™£å åœ</button>
    <button class="mode-btn" onclick="switchMode('physical')">ğŸ–ï¸ å¯¦é«”æŠ½ç‰Œè¼¸å…¥</button>
</div>

<section id="browseSection">
    <div class="controls">
        <input type="text" id="searchInput" placeholder="è¼¸å…¥é—œéµå­— (ä¾‹å¦‚ï¼šæ„›æƒ…ã€éŒ¢ã€å¯¶åŠ...)">
        <div class="filter-buttons">
            <button class="filter-btn active" onclick="filter('all', this)">å…¨éƒ¨</button>
            <button class="filter-btn" onclick="filter('major', this)">å¤§é˜¿çˆ¾å…‹é‚£</button>
            <button class="filter-btn" onclick="filter('fire', this)">æ¬Šæ– (ç«)</button>
            <button class="filter-btn" onclick="filter('water', this)">è–æ¯ (æ°´)</button>
            <button class="filter-btn" onclick="filter('air', this)">å¯¶åŠ (é¢¨)</button>
            <button class="filter-btn" onclick="filter('earth', this)">éŒ¢å¹£ (åœŸ)</button>
        </div>
    </div>
    <div id="browseGrid" class="grid"></div>
</section>

<section id="readingSection" class="hidden">
    
    <div id="spreadControls" class="controls hidden">
        <h3 class="text-center">è«‹é¸æ“‡å åœç‰Œé™£</h3>
        <select id="spreadSelect" onchange="updateSpreadInfo()">
            <optgroup label="åŸºç¤ç‰Œé™£">
                <option value="threeCard">æ™‚é–“ä¹‹æµ (3å¼µ)</option>
                <option value="fourElement">å…ƒç´ å¹³è¡¡ (4å¼µ)</option>
                <option value="choice">äºŒæ“‡ä¸€æŠ‰æ“‡ (5å¼µ)</option>
            </optgroup>
            <optgroup label="æ„›æƒ…èˆ‡é—œä¿‚">
                <option value="loversPyramid">æˆ€äººé‡‘å­—å¡” (4å¼µ)</option>
                <option value="relationshipCross">é—œä¿‚åå­— (5å¼µ)</option>
            </optgroup>
            <optgroup label="æ·±åº¦åˆ†æèˆ‡å»ºè­°">
                <option value="mindBodySpirit">èº«å¿ƒéˆå¥åº· (3å¼µ)</option>
                <option value="littleCross">å°åå­—å åœ (4å¼µ)</option>
                <option value="problemSolving">å•é¡Œè§£æ±º (3å¼µ)</option>
                <option value="diamond">é‘½çŸ³æ¨æ¸¬æ³• (5å¼µ)</option>
                <option value="horseshoe">é¦¬è¹„éµå åœ (7å¼µ)</option>
                <option value="hexagram">å…­èŠ’æ˜Ÿå åœ (7å¼µ)</option>
                <option value="celticCross">å‡±çˆ¾ç‰¹åå­— (10å¼µ)</option>
            </optgroup>
            <optgroup label="é‹å‹¢é æ¸¬">
                <option value="weeklyForecast">ä¸€é€±é‹å‹¢ (7å¼µ)</option>
            </optgroup>
        </select>
        <div id="spreadDesc" class="spread-info"></div>
        <button class="action-btn" onclick="startSpreadReading()">é–‹å§‹ç‰Œé™£å åœ</button>
    </div>

    <div id="physicalControls" class="controls hidden">
        <div class="spread-info text-center" style="background:#dfe6e9; color:#2d3436;">
            <strong>ğŸ–ï¸ å¯¦é«”æŠ½ç‰Œæ¨¡å¼</strong><br>
            è¼¸å…¥æ‚¨å¯¦éš›æŠ½åˆ°çš„ç‰Œã€‚è‹¥é¸æ“‡ã€Œè‡ªç”±æŠ½ç‰Œã€ï¼Œå¯è‡ªè¨‚å•é¡Œã€ç„¡é™æ–°å¢ç‰Œå¡ã€‚
        </div>

        <div id="questionInputArea" style="margin-bottom: 15px;">
            <input type="text" id="freeQuestion" placeholder="ğŸ¤” è«‹è¼¸å…¥æ‚¨æƒ³å•çš„å•é¡Œ... (ä¾‹å¦‚ï¼šæˆ‘çš„ç‰Œæ˜¯å¦æœ‰ç‰Œéˆï¼Ÿ)" 
                   style="border: 2px solid #6c5ce7; background: #f8f9fa;">
        </div>

        <select id="physicalSpreadSelect" onchange="initPhysicalGrid()">
            <option value="freeMode" style="font-weight:bold; color:#6c5ce7;">âœ¨ è‡ªç”±æŠ½ç‰Œ (ç„¡é™åˆ¶ï¼Œå¯åˆªé™¤)</option>
            <optgroup label="åŸºç¤ç‰Œé™£">
                <option value="threeCard">æ™‚é–“ä¹‹æµ (3å¼µ)</option>
                <option value="fourElement">å…ƒç´ å¹³è¡¡ (4å¼µ)</option>
                <option value="choice">äºŒæ“‡ä¸€æŠ‰æ“‡ (5å¼µ)</option>
            </optgroup>
            <optgroup label="æ„›æƒ…èˆ‡é—œä¿‚">
                <option value="loversPyramid">æˆ€äººé‡‘å­—å¡” (4å¼µ)</option>
                <option value="relationshipCross">é—œä¿‚åå­— (5å¼µ)</option>
            </optgroup>
            <optgroup label="æ·±åº¦åˆ†æèˆ‡å»ºè­°">
                <option value="mindBodySpirit">èº«å¿ƒéˆå¥åº· (3å¼µ)</option>
                <option value="littleCross">å°åå­—å åœ (4å¼µ)</option>
                <option value="problemSolving">å•é¡Œè§£æ±º (3å¼µ)</option>
                <option value="diamond">é‘½çŸ³æ¨æ¸¬æ³• (5å¼µ)</option>
                <option value="horseshoe">é¦¬è¹„éµå åœ (7å¼µ)</option>
                <option value="hexagram">å…­èŠ’æ˜Ÿå åœ (7å¼µ)</option>
                <option value="celticCross">å‡±çˆ¾ç‰¹åå­— (10å¼µ)</option>
            </optgroup>
        </select>
        <button class="secondary-btn" onclick="initPhysicalGrid()">ğŸ”„ é‡ç½® / æ¸…ç©º</button>
    </div>

    <div id="dailyControls" class="controls hidden">
        <div class="spread-info text-center">
            <strong>æ¯æ—¥ä¸€æŠ½</strong><br>é€™æ˜¯ä¸€å¼µçµ¦äºˆæ‚¨ä»Šæ—¥æ•´é«”èƒ½é‡æŒ‡å¼•çš„ç‰Œï¼Œå»ºè­°åœ¨æ—©æ™¨æŠ½å–ï¼Œä½œç‚ºä¸€å¤©çš„æé†’ã€‚
        </div>
        <button class="action-btn" onclick="drawDailyCard()">âœ¨ æŠ½å–ä»Šæ—¥æŒ‡å¼•ç‰Œ âœ¨</button>
    </div>

    <div id="resultActions" class="controls hidden">
        <div class="btn-group">
            <button class="secondary-btn" onclick="saveCurrentReading()">ğŸ’¾ ä¿å­˜çµæœ</button>
            <button class="secondary-btn ai-btn" onclick="generateAIPrompt()">ğŸ¤– è¤‡è£½ AI è§£ç‰ŒæŒ‡ä»¤</button>
        </div>
    </div>

    <div id="readingGrid" class="grid"></div>
</section>

<div id="historyModal" class="modal-overlay">
    <div class="modal">
        <span class="close-modal" onclick="closeHistory()">&times;</span>
        <h2>ğŸ“œ æ­·å²å åœç´€éŒ„</h2>
        <div id="historyList"></div>
        <button class="secondary-btn" style="width:100%; margin-top:20px;" onclick="clearHistory()">æ¸…ç©ºæ‰€æœ‰ç´€éŒ„</button>
    </div>
</div>

<div id="pickerModal" class="modal-overlay">
    <div class="modal">
        <span class="close-modal" onclick="closePicker()">&times;</span>
        <h3 id="pickerTitle">é¸æ“‡ç‰Œå¡</h3>
        
        <div class="picker-tabs">
            <div class="picker-tab active" onclick="renderPickerGrid('all', this)">å…¨éƒ¨</div>
            <div class="picker-tab" onclick="renderPickerGrid('major', this)">å¤§ç‰Œ</div>
            <div class="picker-tab" onclick="renderPickerGrid('fire', this)">æ¬Šæ–</div>
            <div class="picker-tab" onclick="renderPickerGrid('water', this)">è–æ¯</div>
            <div class="picker-tab" onclick="renderPickerGrid('air', this)">å¯¶åŠ</div>
            <div class="picker-tab" onclick="renderPickerGrid('earth', this)">éŒ¢å¹£</div>
        </div>

        <div id="pickerGrid" class="picker-grid"></div>

        <div class="picker-options">
            <label class="checkbox-wrapper">
                <input type="checkbox" id="pickerReverse">
                <span>é€†ä½ (Reversed)</span>
            </label>
        </div>
    </div>
</div>

<script>
    const imgBaseUrl = "https://www.sacred-texts.com/tarot/pkt/img/";
    
    // --- å®Œæ•´ç‰Œåº«è³‡æ–™ (å…±78å¼µ) ---
    const cards = [
        // --- å¤§é˜¿çˆ¾å…‹é‚£ ---
        {c:"ar00", n:"0. æ„šè€…", e:"major", u:"æ–°çš„é–‹å§‹ã€å†’éšªã€å¤©çœŸã€æ½›åŠ›", r:"é­¯è½ã€å†’éšªéåº¦ã€æ„šè ¢"},
        {c:"ar01", n:"I. é­”è¡“å¸«", e:"major", u:"å‰µé€ åŠ›ã€æŠ€èƒ½ã€æ„å¿—åŠ›ã€é¡¯åŒ–", r:"æ¬ºé¨™ã€æ“ç¸±ã€æ‰è¯è¢«åŸ‹æ²’"},
        {c:"ar02", n:"II. å¥³ç¥­å¸", e:"major", u:"ç›´è¦ºã€ç¥ç§˜ã€æ½›æ„è­˜ã€å…§åœ¨æ™ºæ…§", r:"å£“æŠ‘ç›´è¦ºã€è†šæ·ºã€éš±è—æ•µäºº"},
        {c:"ar03", n:"III. çš‡å", e:"major", u:"è±ç››ã€æ¯æ€§ã€è‡ªç„¶ã€æ„Ÿå®˜äº«å—", r:"ä¾è³´ã€å‰µé€ åŠ›å—é˜»ã€éåº¦ä¿è­·"},
        {c:"ar04", n:"IV. çš‡å¸", e:"major", u:"æ¬Šå¨ã€çµæ§‹ã€æ§åˆ¶ã€çˆ¶è¦ªå½¢è±¡", r:"æš´æ”¿ã€åƒµåŒ–ã€æ¿«ç”¨æ¬ŠåŠ›"},
        {c:"ar05", n:"V. æ•™çš‡", e:"major", u:"å‚³çµ±ã€ä¿¡ä»°ã€å®—æ•™ã€åœ˜é«”", r:"æŒ‘æˆ°å‚³çµ±ã€æ¨™æ–°ç«‹ç•°ã€å—é™"},
        {c:"ar06", n:"VI. æˆ€äºº", e:"major", u:"æ„›ã€å’Œè«§ã€é—œä¿‚ã€é¸æ“‡ã€çµåˆ", r:"ä¸å’Œè«§ã€å¤±è¡¡ã€éŒ¯èª¤é¸æ“‡"},
        {c:"ar07", n:"VII. æˆ°è»Š", e:"major", u:"å‹åˆ©ã€æ„å¿—åŠ›ã€è‡ªå¾‹ã€æ±ºå¿ƒ", r:"å¤±æ§ã€å¤±æ•—ã€ç¼ºä¹æ–¹å‘"},
        {c:"ar08", n:"VIII. åŠ›é‡", e:"major", u:"å…§åœ¨åŠ›é‡ã€å‹‡æ°£ã€è€å¿ƒã€åŒæƒ…", r:"è‡ªæˆ‘æ‡·ç–‘ã€è»Ÿå¼±ã€ææ‡¼"},
        {c:"ar09", n:"IX. éš±å£«", e:"major", u:"å…§çœã€å­¤ç¨ã€å°‹æ±‚çœŸç†ã€æŒ‡å°", r:"å­¤ç«‹ã€å¯‚å¯ã€é€€ç¸®ã€è¿·å¤±"},
        {c:"ar10", n:"X. å‘½é‹ä¹‹è¼ª", e:"major", u:"å¥½é‹ã€æ¥­åŠ›ã€ç”Ÿå‘½é€±æœŸã€æ©Ÿæœƒ", r:"å„é‹ã€æŠµæŠ—è®ŠåŒ–ã€æƒ¡æ€§å¾ªç’°"},
        {c:"ar11", n:"XI. æ­£ç¾©", e:"major", u:"å…¬æ­£ã€çœŸç†ã€å› æœã€æ³•å¾‹", r:"ä¸å…¬ã€åè¦‹ã€ä¸èª å¯¦"},
        {c:"ar12", n:"XII. åŠäºº", e:"major", u:"çŠ§ç‰²ã€æ–°è¦–è§’ã€æš«åœã€ç­‰å¾…", r:"ç„¡è¬‚çŠ§ç‰²ã€åœæ»¯ã€æ‹–å»¶"},
        {c:"ar13", n:"XIII. æ­»ç¥", e:"major", u:"çµæŸã€è½‰è®Šã€é‡ç”Ÿã€æ–·æ¨é›¢", r:"æŠ—æ‹’æ”¹è®Šã€åœæ»¯ã€ç„¡æ³•é‡‹æ‡·"},
        {c:"ar14", n:"XIV. ç¯€åˆ¶", e:"major", u:"å¹³è¡¡ã€é©åº¦ã€è€å¿ƒã€å’Œè«§", r:"å¤±è¡¡ã€éåº¦ã€ç¼ºä¹è€å¿ƒ"},
        {c:"ar15", n:"XV. æƒ¡é­”", e:"major", u:"æŸç¸›ã€æˆç™®ã€ç‰©è³ªä¸»ç¾©ã€æ€§æ…¾", r:"æ‰“ç ´æŸç¸›ã€é‡ç²è‡ªç”±ã€è¦ºé†’"},
        {c:"ar16", n:"XVI. é«˜å¡”", e:"major", u:"çªè®Šã€ç½é›£ã€å•Ÿç¤ºã€æ··äº‚", r:"é¿å…ç½é›£ã€å»¶é²æ”¹è®Šã€é‡å»º"},
        {c:"ar17", n:"XVII. æ˜Ÿæ˜Ÿ", e:"major", u:"å¸Œæœ›ã€éˆæ„Ÿã€å¹³éœã€ç™‚ç™’", r:"çµ•æœ›ã€ç¼ºä¹ä¿¡å¿ƒã€éŒ¯å¤±æ©Ÿæœƒ"},
        {c:"ar18", n:"XVIII. æœˆäº®", e:"major", u:"å¹»è¦ºã€ææ‡¼ã€æ½›æ„è­˜ã€ä¸å®‰", r:"æ··äº‚æ¾„æ¸…ã€é‡‹æ”¾ææ‡¼ã€æ­éœ²"},
        {c:"ar19", n:"XIX. å¤ªé™½", e:"major", u:"å¿«æ¨‚ã€æˆåŠŸã€æ´»åŠ›ã€æº«æš–", r:"æš«æ™‚æŒ«æŠ˜ã€éåº¦æ¨‚è§€ã€è™›æ¦®"},
        {c:"ar20", n:"XX. å¯©åˆ¤", e:"major", u:"é‡ç”Ÿã€å¬å–šã€è¦ºé†’ã€å› æœ", r:"è‡ªæˆ‘æ‡·ç–‘ã€æ‹’çµ•å¬å–šã€å¾Œæ‚”"},
        {c:"ar21", n:"XXI. ä¸–ç•Œ", e:"major", u:"å®Œæˆã€æ•´åˆã€æˆå°±ã€åœ“æ»¿", r:"æœªå®Œæˆã€ç¼ºä¹æ”¶å°¾ã€å»¶é²"},
        // --- æ¬Šæ– ---
        {c:"waac", n:"æ¬Šæ–ç‹ç‰Œ", e:"fire", u:"éˆæ„Ÿã€æ–°æ©Ÿæœƒã€æˆé•·ã€ç†±æƒ…", r:"å»¶é²ã€ç¼ºä¹å‹•åŠ›ã€éŒ¯å¤±æ©Ÿæœƒ"},
        {c:"wa02", n:"æ¬Šæ–äºŒ", e:"fire", u:"è¨ˆç•«ã€æœªä¾†å±•æœ›ã€æ±ºå®šã€ç™¼ç¾", r:"ææ‡¼æœªçŸ¥ã€ç¼ºä¹è¨ˆç•«ã€çŒ¶è±«"},
        {c:"wa03", n:"æ¬Šæ–ä¸‰", e:"fire", u:"æ“´å¼µã€é è¦‹ã€æµ·å¤–æ©Ÿæœƒã€é€²æ­¥", r:"éšœç¤™ã€å»¶èª¤ã€æŒ«æŠ˜ã€é€€ç¸®"},
        {c:"wa04", n:"æ¬Šæ–å››", e:"fire", u:"æ…¶ç¥ã€å’Œè«§ã€æ­¸å±¬æ„Ÿã€ç©©å®š", r:"å®¶åº­è¡çªã€éæ¸¡æœŸã€ä¸ç©©å®š"},
        {c:"wa05", n:"æ¬Šæ–äº”", e:"fire", u:"è¡çªã€ç«¶çˆ­ã€åˆ†æ­§ã€æ··äº‚", r:"é¿å…è¡çªã€é”æˆå…±è­˜"},
        {c:"wa06", n:"æ¬Šæ–å…­", e:"fire", u:"å‹åˆ©ã€èªå¯ã€æ¦®è­½ã€è‡ªä¿¡", r:"å¤±æ•—ã€åè²å—æã€é©•å‚²è‡ªå¤§"},
        {c:"wa07", n:"æ¬Šæ–ä¸ƒ", e:"fire", u:"æŒ‘æˆ°ã€å …æŒç«‹å ´ã€é˜²ç¦¦ã€æ¯…åŠ›", r:"æ”¾æ£„ã€è¢«å£“å€’ã€ç¼ºä¹è‡ªä¿¡"},
        {c:"wa08", n:"æ¬Šæ–å…«", e:"fire", u:"è¿…é€Ÿè¡Œå‹•ã€æ¶ˆæ¯ã€æ—…è¡Œã€é€²å±•", r:"å»¶é²ã€æŒ«æŠ˜ã€æ··äº‚ã€è¡å‹•"},
        {c:"wa09", n:"æ¬Šæ–ä¹", e:"fire", u:"éŸŒæ€§ã€å‹‡æ°£ã€å …æŒåˆ°åº•", r:"æ”¾æ£„ã€ç­‹ç–²åŠ›ç›¡ã€å›ºåŸ·"},
        {c:"wa10", n:"æ¬Šæ–å", e:"fire", u:"è² æ“”ã€è²¬ä»»ã€å£“åŠ›ã€åŠªåŠ›å·¥ä½œ", r:"å´©æ½°ã€ç„¡æ³•æ‰¿å—ã€æ¨å¸è²¬ä»»"},
        {c:"wapa", n:"æ¬Šæ–ä¾è€…", e:"fire", u:"æ¢ç´¢ã€æ–°æ¶ˆæ¯ã€ç†±æƒ…ã€å¥½å¥‡å¿ƒ", r:"å£æ¶ˆæ¯ã€ç¼ºä¹æ–¹å‘ã€æ‹–å»¶"},
        {c:"wakn", n:"æ¬Šæ–é¨å£«", e:"fire", u:"è¡Œå‹•ã€å†’éšªã€è¡å‹•ã€ç²¾åŠ›", r:"é­¯è½ã€æ†¤æ€’ã€æ€¥èºã€å‚²æ…¢"},
        {c:"waqu", n:"æ¬Šæ–çš‡å", e:"fire", u:"è‡ªä¿¡ã€ç†±æƒ…ã€æ±ºå¿ƒã€ç¤¾äº¤", r:"å«‰å¦’ã€æƒ…ç·’åŒ–ã€æ§åˆ¶æ¬²"},
        {c:"waki", n:"æ¬Šæ–åœ‹ç‹", e:"fire", u:"é ˜å°åŠ›ã€é è¦‹ã€å¤§è†½ã€ä¼æ¥­å®¶", r:"ç¨è£ã€è¡å‹•ã€ç„¡æƒ…"},
        // --- è–æ¯ ---
        {c:"cuac", n:"è–æ¯ç‹ç‰Œ", e:"water", u:"æ–°æˆ€æƒ…ã€åŒæƒ…å¿ƒã€å‰µé€ åŠ›", r:"æƒ…æ„Ÿå£“æŠ‘ã€ç©ºè™›ã€å¤±æˆ€"},
        {c:"cu02", n:"è–æ¯äºŒ", e:"water", u:"ä¼´ä¾¶é—œä¿‚ã€å¸å¼•åŠ›ã€åˆä½œ", r:"ä¸å¹³è¡¡ã€ç ´è£‚ã€èª¤è§£"},
        {c:"cu03", n:"è–æ¯ä¸‰", e:"water", u:"æ…¶ç¥ã€å‹èª¼ã€åœ˜é«”ã€åˆä½œ", r:"éåº¦æ”¾ç¸±ã€å…«å¦ã€å­¤ç«‹"},
        {c:"cu04", n:"è–æ¯å››", e:"water", u:"å†·æ¼ ã€æ²ˆæ€ã€éŒ¯å¤±æ©Ÿæœƒã€å­å€¦", r:"æŠ“ä½æ©Ÿæœƒã€è¦ºé†’ã€æ–°çš„ç†±æƒ…"},
        {c:"cu05", n:"è–æ¯äº”", e:"water", u:"å¤±è½ã€æ‚²å‚·ã€å¾Œæ‚”ã€å¤±æœ›", r:"æ¥å—ã€åŸè«’ã€èµ°å‡ºæ‚²å‚·"},
        {c:"cu06", n:"è–æ¯å…­", e:"water", u:"æ‡·èˆŠã€ç«¥å¹´å›æ†¶ã€ç´”çœŸã€é‡é€¢", r:"æ²ˆæººéå»ã€æ‹’çµ•é•·å¤§ã€éºå¿˜"},
        {c:"cu07", n:"è–æ¯ä¸ƒ", e:"water", u:"å¹»æƒ³ã€é¸æ“‡ã€ç™½æ—¥å¤¢ã€æ··äº‚", r:"çœ‹æ¸…ç¾å¯¦ã€åšå‡ºé¸æ“‡ã€æ¸…æ™°"},
        {c:"cu08", n:"è–æ¯å…«", e:"water", u:"é›¢é–‹ã€å°‹æ‰¾çœŸç†ã€å¤±æœ›ã€æ—…è¡Œ", r:"çŒ¶è±«ä¸æ±ºã€ææ‡¼æ”¹è®Š"},
        {c:"cu09", n:"è–æ¯ä¹", e:"water", u:"é¡˜æœ›æˆçœŸã€æ»¿è¶³ã€å¿«æ¨‚ã€äº«å—", r:"è²ªå©ªã€ä¸æ»¿ã€ç‚«è€€ã€æ”¾ç¸±"},
        {c:"cu10", n:"è–æ¯å", e:"water", u:"å®¶åº­å¹¸ç¦ã€å’Œè«§ã€æƒ…æ„Ÿåœ“æ»¿", r:"å®¶åº­å¤±å’Œã€åƒ¹å€¼è§€è¡çª"},
        {c:"cupa", n:"è–æ¯ä¾è€…", e:"water", u:"æ–°æ¶ˆæ¯ã€ç›´è¦ºã€å‰µæ„", r:"æƒ…ç·’ä¸ç©©ã€å£æ¶ˆæ¯ã€å¹¼ç¨š"},
        {c:"cukn", n:"è–æ¯é¨å£«", e:"water", u:"æµªæ¼«ã€æ±‚æ„›ã€é­…åŠ›ã€æƒ³åƒåŠ›", r:"æƒ…ç·’åŒ–ã€æ¬ºé¨™ã€ä¸åˆ‡å¯¦éš›"},
        {c:"cuqu", n:"è–æ¯çš‡å", e:"water", u:"æ…ˆæ‚²ã€é—œæ‡·ã€ç›´è¦ºã€æƒ…æ„Ÿæ·±åº¦", r:"ä¾è³´ã€æƒ…ç·’å‹’ç´¢ã€å¤šæ„å–„æ„Ÿ"},
        {c:"cuki", n:"è–æ¯åœ‹ç‹", e:"water", u:"æƒ…ç·’å¹³è¡¡ã€å¯¬å®¹ã€å¤–äº¤ã€æ™ºæ…§", r:"å†·æ¼ ã€æƒ…ç·’æ“æ§ã€å–œæ€’ç„¡å¸¸"},
        // --- å¯¶åŠ ---
        {c:"swac", n:"å¯¶åŠç‹ç‰Œ", e:"air", u:"çªç ´ã€æ¸…æ™°ã€æ–°æƒ³æ³•ã€çœŸç†", r:"æ··äº‚ã€æ€ç·’ä¸æ¸…ã€æ®˜é…·"},
        {c:"sw02", n:"å¯¶åŠäºŒ", e:"air", u:"åƒµå±€ã€å›°é›£æ±ºå®šã€é€ƒé¿ã€å¦¥å”", r:"åšå‡ºæ±ºå®šã€æ­éœ²çœŸç›¸ã€é‡‹æ”¾"},
        {c:"sw03", n:"å¯¶åŠä¸‰", e:"air", u:"å¿ƒç¢ã€æ‚²å‚·ã€ç—›è‹¦ã€åˆ†é›¢", r:"é‡‹æ”¾ç—›è‹¦ã€åŸè«’ã€åº·å¾©"},
        {c:"sw04", n:"å¯¶åŠå››", e:"air", u:"ä¼‘æ¯ã€æ¢å¾©ã€æ²ˆæ€ã€æš«åœ", r:"éå‹ã€æ¢å¾©æ´»å‹•ã€å£“åŠ›"},
        {c:"sw05", n:"å¯¶åŠäº”", e:"air", u:"è¡çªã€å¤±æ•—ã€è‡ªç§ã€ä¸æ“‡æ‰‹æ®µ", r:"å’Œè§£ã€åŸè«’ã€è§£æ±ºè¡çª"},
        {c:"sw06", n:"å¯¶åŠå…­", e:"air", u:"éæ¸¡ã€é›¢é–‹ç—›è‹¦ã€ç™‚ç™’ä¹‹æ—…", r:"æƒ…æ„ŸåŒ…è¢±ã€ç„¡æ³•å‰é€²"},
        {c:"sw07", n:"å¯¶åŠä¸ƒ", e:"air", u:"æ¬ºé¨™ã€ç­–ç•¥ã€å·ç«Šã€é€ƒé¿è²¬ä»»", r:"è‡ªç™½ã€è¢«æ­ç©¿ã€è‰¯å¿ƒç™¼ç¾"},
        {c:"sw08", n:"å¯¶åŠå…«", e:"air", u:"æŸç¸›ã€å—å®³è€…å¿ƒæ…‹ã€ç„¡åŠ›æ„Ÿ", r:"é‡ç²è‡ªç”±ã€æ–°è¦–è§’ã€è§£æ±ºå•é¡Œ"},
        {c:"sw09", n:"å¯¶åŠä¹", e:"air", u:"ç„¦æ…®ã€å™©å¤¢ã€ææ‡¼ã€çµ•æœ›", r:"ææ‡¼é‡‹æ”¾ã€æ±‚åŠ©ã€å¥½è½‰"},
        {c:"sw10", n:"å¯¶åŠå", e:"air", u:"æ¯€æ»…ã€ç—›è‹¦çµæŸã€èƒŒå›", r:"å¾©ç”¦ã€å€–å­˜ã€ä¸å¯é¿å…çš„çµæŸ"},
        {c:"swpa", n:"å¯¶åŠä¾è€…", e:"air", u:"å¥½å¥‡ã€æ–°æƒ³æ³•ã€æºé€šã€è§€å¯Ÿ", r:"æ•£æ¼«ã€æ¬ºé¨™ã€èªªé–’è©±ã€ååŸ·"},
        {c:"swkn", n:"å¯¶åŠé¨å£«", e:"air", u:"é‡å¿ƒã€è¡Œå‹•è¿…é€Ÿã€ç›´æ¥", r:"è¡å‹•ã€é­¯è½ã€è¨€èªæš´åŠ›"},
        {c:"swqu", n:"å¯¶åŠçš‡å", e:"air", u:"ç¨ç«‹ã€æ¸…æ™°åˆ¤æ–·ã€ç•Œç·šã€ç›´æ¥", r:"å†·é…·ã€è‹¦æ¾€ã€æ®˜å¿ã€æƒ…ç·’åŒ–"},
        {c:"swki", n:"å¯¶åŠåœ‹ç‹", e:"air", u:"ç†æ™ºæ¬Šå¨ã€çœŸç†ã€å…¬æ­£ã€ç´€å¾‹", r:"æ“ç¸±ã€æš´å›ã€æ®˜å¿ã€å†·è¡€"},
        // --- éŒ¢å¹£ ---
        {c:"peac", n:"éŒ¢å¹£ç‹ç‰Œ", e:"earth", u:"æ–°æ©Ÿæœƒã€ç¹æ¦®ã€è²¡å¯Œã€ç©©å®š", r:"éŒ¯å¤±æ©Ÿæœƒã€è²¡å‹™æå¤±ã€è²ªå©ª"},
        {c:"pe02", n:"éŒ¢å¹£äºŒ", e:"earth", u:"å¹³è¡¡ã€é©æ‡‰ã€å¤šé‡ä»»å‹™", r:"å¤±è¡¡ã€æ··äº‚ã€è²¡å‹™å›°é›£"},
        {c:"pe03", n:"éŒ¢å¹£ä¸‰", e:"earth", u:"åœ˜éšŠåˆä½œã€æŠ€èƒ½ã€åŸ·è¡Œã€å“è³ª", r:"ç¼ºä¹åˆä½œã€å·¥ä½œæ‡¶æ•£"},
        {c:"pe04", n:"éŒ¢å¹£å››", e:"earth", u:"å®ˆè²¡ã€æ§åˆ¶ã€å®‰å…¨æ„Ÿã€ç©©å®š", r:"æ…·æ…¨ã€å¤±å»æ§åˆ¶ã€æ®éœ"},
        {c:"pe05", n:"éŒ¢å¹£äº”", e:"earth", u:"è²§çª®ã€å­¤ç«‹ã€ä¸å®‰å…¨æ„Ÿã€æå¤±", r:"æ¢å¾©ã€æ´åŠ©åˆ°ä¾†ã€å¥½è½‰"},
        {c:"pe06", n:"éŒ¢å¹£å…­", e:"earth", u:"æ…·æ…¨ã€æ…ˆå–„ã€çµ¦äºˆèˆ‡æ¥å—", r:"å‚µå‹™ã€è‡ªç§ã€ä¸å¹³ç­‰äº¤æ˜“"},
        {c:"pe07", n:"éŒ¢å¹£ä¸ƒ", e:"earth", u:"è€å¿ƒã€è©•ä¼°ã€é•·æœŸæŠ•è³‡", r:"ç¼ºä¹å›å ±ã€ç„¦æ…®ã€æ”¾æ£„"},
        {c:"pe08", n:"éŒ¢å¹£å…«", e:"earth", u:"å‹¤å¥®ã€æŠ€èƒ½ç²¾é€²ã€å°ˆæ³¨ç´°ç¯€", r:"å®Œç¾ä¸»ç¾©ã€ç¼ºä¹é‡å¿ƒ"},
        {c:"pe09", n:"éŒ¢å¹£ä¹", e:"earth", u:"å¯Œè¶³ã€ç¨ç«‹ã€äº«å—ç”Ÿæ´»", r:"ä¾è³´ã€è²¡å‹™ä¾è³´ã€è†šæ·º"},
        {c:"pe10", n:"éŒ¢å¹£å", e:"earth", u:"éºç”¢ã€å®¶åº­å¯Œè£•ã€é•·æœŸç©©å®š", r:"å®¶åº­ç´›çˆ­ã€è²¡å‹™å¤±æ•—"},
        {c:"pepa", n:"éŒ¢å¹£ä¾è€…", e:"earth", u:"å±•ç¾ã€å­¸ç¿’æ©Ÿæœƒã€å‹¤å¥®ã€å‹™å¯¦", r:"æ‹–å»¶ã€ç¼ºä¹é€²æ­¥ã€æ‡¶æƒ°"},
        {c:"pekn", n:"éŒ¢å¹£é¨å£«", e:"earth", u:"æ•ˆç‡ã€ä¾‹è¡Œå…¬äº‹ã€ä¿å®ˆ", r:"åœæ»¯ã€æ‡¶æƒ°ã€é ‘å›ºã€ç„¡èŠ"},
        {c:"pequ", n:"éŒ¢å¹£çš‡å", e:"earth", u:"å‹™å¯¦ã€æ»‹é¤Šã€è²¡å‹™å®‰å…¨ã€æ„›å®¶", r:"å·¥ä½œç‹‚ã€å«‰å¦’ã€è‡ªæˆ‘æ‡·ç–‘"},
        {c:"peki", n:"éŒ¢å¹£åœ‹ç‹", e:"earth", u:"å¯Œè£•ã€å•†æ¥­é ­è…¦ã€ç´€å¾‹", r:"è²ªå©ªã€å›ºåŸ·ã€ç‰©è³ªä¸»ç¾©"}
    ];

    const spreadDefinitions = {
        freeMode: {
            name: "è‡ªç”±æŠ½ç‰Œ (ç„¡ç‰Œé™£)",
            description: "ç„¡é™åˆ¶æŠ½ç‰Œå¼µæ•¸ï¼Œé©åˆç›´è¦ºå¼å åœæˆ–ä¸æ–·è¿½å•ã€‚",
            positions: [] // å‹•æ…‹ç”Ÿæˆ
        },
        threeCard: {
            name: "æ™‚é–“ä¹‹æµç‰Œé™£",
            description: "æœ€åŸºç¤ä¹Ÿæœ€å¸¸ç”¨çš„ç‰Œé™£ã€‚ç”¨æ–¼æŸ¥çœ‹æŸä»¶äº‹çš„éå»èµ·å› ã€ç¾åœ¨ç‹€æ³ä»¥åŠæœªä¾†çš„è‡ªç„¶ç™¼å±•è¶¨å‹¢ã€‚",
            positions: ["1. éå»/åŸå› ", "2. ç¾åœ¨/ç‹€æ³", "3. æœªä¾†/çµæœ"]
        },
        fourElement: {
            name: "å››å…ƒç´ å¹³è¡¡ç‰Œé™£",
            description: "æª¢è¦–æ‚¨ç›®å‰çš„èƒ½é‡ç‹€æ…‹ã€‚ç«ä»£è¡¨è¡Œå‹•åŠ›ï¼Œæ°´ä»£è¡¨æƒ…æ„Ÿï¼Œé¢¨ä»£è¡¨æ€è€ƒï¼ŒåœŸä»£è¡¨ç‰©è³ªèˆ‡å·¥ä½œã€‚",
            positions: ["1. ç«å…ƒç´  (è¡Œå‹•/ç†±æƒ…)", "2. æ°´å…ƒç´  (æƒ…æ„Ÿ/äººéš›)", "3. é¢¨å…ƒç´  (æ€è€ƒ/æºé€š)", "4. åœŸå…ƒç´  (ç‰©è³ª/å·¥ä½œ)"]
        },
        choice: {
            name: "äºŒæ“‡ä¸€æŠ‰æ“‡ç‰Œé™£",
            description: "ç•¶æ‚¨é¢è‡¨å…©å€‹é¸æ“‡ï¼ˆä¾‹å¦‚ï¼šè©²é¸Aå·¥ä½œé‚„æ˜¯Bå·¥ä½œï¼Ÿï¼‰æ™‚ï¼Œæ­¤ç‰Œé™£èƒ½åˆ†æå…©æ¢è·¯å¾‘çš„ç™¼å±•ã€‚",
            positions: ["1. ç›®å‰çš„ç‹€æ³", "2. é¸æ“‡ A çš„éç¨‹", "3. é¸æ“‡ A çš„çµæœ", "4. é¸æ“‡ B çš„éç¨‹", "5. é¸æ“‡ B çš„çµæœ"]
        },
        loversPyramid: {
            name: "æˆ€äººé‡‘å­—å¡”",
            description: "å°ˆé–€é‡å°æ„›æƒ…èˆ‡é—œä¿‚è¨­è¨ˆã€‚åˆ†ææ‚¨è‡ªå·±ã€å°è±¡ã€å…©äººä¹‹é–“çš„é—œä¿‚é€£çµï¼Œä»¥åŠæœªä¾†çš„ç™¼å±•ã€‚",
            positions: ["1. æ‚¨è‡ªå·±", "2. å°è±¡", "3. å½¼æ­¤çš„é—œä¿‚ç‹€æ…‹", "4. æœªä¾†çš„ç™¼å±•"]
        },
        relationshipCross: {
            name: "é—œä¿‚åå­—ç‰Œé™£",
            description: "æ·±å…¥åˆ†æé›™æ–¹äº’å‹•ã€‚åŒ…å«é›™æ–¹å„è‡ªçš„æƒ³æ³•ã€é—œä¿‚ä¸­çš„é˜»ç¤™ï¼Œä»¥åŠæœ€çµ‚çš„çµæœã€‚",
            positions: ["1. æ‚¨åœ¨é—œä¿‚ä¸­çš„ç‹€æ…‹", "2. å°æ–¹åœ¨é—œä¿‚ä¸­çš„ç‹€æ…‹", "3. é—œä¿‚ç›®å‰çš„åŸºç¤", "4. é¢è‡¨çš„é˜»ç¤™æˆ–æŒ‘æˆ°", "5. çµæœèˆ‡å»ºè­°"]
        },
        mindBodySpirit: {
            name: "èº«å¿ƒéˆå¥åº·ç‰Œé™£",
            description: "é—œæ³¨æ‚¨çš„å€‹äººç‹€æ…‹ã€‚å¾èº«é«”å¥åº·ã€å¿ƒç†æƒ…ç·’åˆ°éˆæ€§æˆé•·çµ¦äºˆæŒ‡å¼•ï¼Œé©åˆè‡ªæˆ‘ç™‚ç™’ã€‚",
            positions: ["1. èº«é«” (å¥åº·/æ´»åŠ›)", "2. å¿ƒç† (æƒ…ç·’/æ€ç·’)", "3. éˆæ€§ (æ½›æ„è­˜/æˆé•·)"]
        },
        littleCross: {
            name: "å°åå­—å åœæ³•",
            description: "ç°¡æ½”æœ‰åŠ›çš„å•é¡Œè§£æ±ºç‰Œé™£ã€‚é‡å°å–®ä¸€æ˜ç¢ºçš„å•é¡Œï¼ŒæŒ‡å‡ºæ ¸å¿ƒç‹€æ³ã€é˜»ç¤™èˆ‡è§£æ±ºä¹‹é“ã€‚",
            positions: ["1. æ ¸å¿ƒç‹€æ³", "2. é˜»ç¤™èˆ‡æŒ‘æˆ°", "3. å»ºè­°èˆ‡å°ç­–", "4. çµæœ"]
        },
        problemSolving: {
            name: "å•é¡Œè§£æ±ºç‰Œé™£",
            description: "ç•¶æ‚¨é‡åˆ°ç‰¹å®šå›°é›£æ™‚ï¼Œæ­¤ç‰Œé™£å¹«åŠ©æ‚¨é‡æ¸…å•é¡Œæœ¬è³ªï¼Œä¸¦ç›´æ¥çµ¦å‡ºè§£æ±ºæ–¹æ¡ˆã€‚",
            positions: ["1. å•é¡Œçš„æœ¬è³ª", "2. å°è‡´å•é¡Œçš„åŸå› ", "3. è§£æ±ºæ–¹æ¡ˆ"]
        },
        diamond: {
            name: "é‘½çŸ³æ¨æ¸¬æ³•",
            description: "é©åˆä¸€èˆ¬æ€§çš„å•é¡Œåˆ†æï¼Œæ¶µè“‹éå»å½±éŸ¿ã€æœªä¾†è¶¨å‹¢ä»¥åŠæ‚¨å…§åœ¨çš„æƒ³æ³•ã€‚",
            positions: ["1. éå»çš„å½±éŸ¿", "2. ç¾åœ¨çš„ç‹€æ³", "3. æœªä¾†çš„è¶¨å‹¢", "4. æ‚¨çš„å…§åœ¨æƒ³æ³•/å°ç­–", "5. æœ€çµ‚çµæœ"]
        },
        horseshoe: {
            name: "é¦¬è¹„éµå åœæ³•",
            description: "éå¸¸å…¨é¢çš„ç‰Œé™£ï¼Œåˆ†æäº‹æƒ…çš„æ¼”è®Šéç¨‹ã€‚åŒ…å«éš±è—çš„å½±éŸ¿åŠ›ã€å‘¨é­ç’°å¢ƒä»¥åŠè©²æ¡å–çš„è¡Œå‹•ã€‚",
            positions: ["1. éå»", "2. ç¾åœ¨", "3. éš±è—çš„å½±éŸ¿åŠ›", "4. é˜»ç¤™", "5. å‘¨é­ç’°å¢ƒ/ä»–äººå½±éŸ¿", "6. å»ºè­°æ¡å–çš„è¡Œå‹•", "7. çµæœ"]
        },
        hexagram: {
            name: "å…­èŠ’æ˜Ÿå åœæ³•",
            description: "é«˜éšç‰Œé™£ï¼Œç”¨æ–¼åˆ†æè¤‡é›œæƒ…æ³ã€‚ç²¾ç¢ºæŒ‡å‡ºå•é¡Œçš„æˆå› ã€ç’°å¢ƒå› ç´ ä»¥åŠè§£æ±ºæ–¹æ³•ã€‚",
            positions: ["1. éå»", "2. ç¾åœ¨", "3. æœªä¾†", "4. è§£æ±ºæ–¹æ³•çš„æŒ‡å¼•", "5. å‘¨é­ç’°å¢ƒçš„ç‹€æ³", "6. æ‚¨å°å•é¡Œçš„æ…‹åº¦/å¸Œæœ›", "7. æœ€çµ‚çµæœ"]
        },
        celticCross: {
            name: "å‡±çˆ¾ç‰¹åå­—ç‰Œé™£",
            description: "å¡”ç¾…ä¸­æœ€ç¶“å…¸ã€æœ€è©³ç›¡çš„ç‰Œé™£ã€‚å…¨æ–¹ä½å‰–æä¸€å€‹å•é¡Œçš„å…§å¤–åœ¨å› ç´ ã€æ½›æ„è­˜ã€ææ‡¼èˆ‡å¸Œæœ›ã€‚",
            positions: ["1. ç¾æ³", "2. åŠ©åŠ›æˆ–é˜»åŠ›(äº¤å‰)", "3. æ½›æ„è­˜/æ ¹æº", "4. éå»", "5. æ„è­˜/ç›®æ¨™", "6. å³å°‡ç™¼ç”Ÿçš„æœªä¾†", "7. æ‚¨çš„æ…‹åº¦", "8. ç’°å¢ƒèˆ‡ä»–äººè©•åƒ¹", "9. å¸Œæœ›æˆ–ææ‡¼", "10. æœ€çµ‚çµæœ"]
        },
        weeklyForecast: {
            name: "ä¸€é€±é‹å‹¢ç‰Œé™£",
            description: "é æ¸¬æœªä¾†ä¸€é€±ï¼ˆé€±ä¸€åˆ°é€±æ—¥ï¼‰çš„æ¯æ—¥é‹å‹¢æ¦‚æ³ï¼Œå¹«åŠ©æ‚¨æå‰è¦åŠƒã€‚",
            positions: ["1. æ˜ŸæœŸä¸€", "2. æ˜ŸæœŸäºŒ", "3. æ˜ŸæœŸä¸‰", "4. æ˜ŸæœŸå››", "5. æ˜ŸæœŸäº”", "6. æ˜ŸæœŸå…­", "7. æ˜ŸæœŸæ—¥"]
        }
    };

    const browseGrid = document.getElementById('browseGrid');
    const readingGrid = document.getElementById('readingGrid');
    const input = document.getElementById('searchInput');
    const browseSection = document.getElementById('browseSection');
    const readingSection = document.getElementById('readingSection');
    const spreadControls = document.getElementById('spreadControls');
    const physicalControls = document.getElementById('physicalControls');
    const dailyControls = document.getElementById('dailyControls');
    const spreadDesc = document.getElementById('spreadDesc');
    const resultActions = document.getElementById('resultActions');
    const pickerModal = document.getElementById('pickerModal');
    
    let currentType = 'all';
    let currentReadingResult = null; // ç”¨æ–¼å„²å­˜ç•¶å‰å åœçµæœä»¥ä¾›ä¿å­˜
    let currentMode = 'browse';
    let pendingSlotIndex = null; // å¯¦é«”æŠ½ç‰Œæ™‚ï¼Œæ­£åœ¨é¸æ“‡å“ªä¸€å€‹å¡æ§½

    // --- æ´—ç‰Œ ---
    function shuffleDeck() {
        const deck = [...cards];
        for (let i = deck.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [deck[i], deck[j]] = [deck[j], deck[i]];
        }
        return deck;
    }

    // --- UI é‚è¼¯ ---
    function updateSpreadInfo() {
        const key = document.getElementById('spreadSelect').value;
        const spread = spreadDefinitions[key];
        spreadDesc.innerHTML = `<strong>${spread.name}ï¼š</strong><br>${spread.description}`;
    }

    function switchMode(mode) {
        currentMode = mode;
        // æ›´æ–°æŒ‰éˆ•ç‹€æ…‹
        document.querySelectorAll('.mode-btn').forEach(btn => {
            const btnText = btn.innerText;
            if (mode === 'browse' && btnText.includes('ç€è¦½')) btn.classList.add('active');
            else if (mode === 'daily' && btnText.includes('æ¯æ—¥')) btn.classList.add('active');
            else if (mode === 'spread' && btnText.includes('ç·šä¸Š')) btn.classList.add('active');
            else if (mode === 'physical' && btnText.includes('å¯¦é«”')) btn.classList.add('active');
            else btn.classList.remove('active');
        });

        // éš±è—/é¡¯ç¤ºå€å¡Š
        browseSection.classList.add('hidden');
        readingSection.classList.add('hidden');
        spreadControls.classList.add('hidden');
        physicalControls.classList.add('hidden');
        dailyControls.classList.add('hidden');
        resultActions.classList.add('hidden');
        readingGrid.innerHTML = ''; 
        currentReadingResult = null;

        if (mode === 'browse') {
            browseSection.classList.remove('hidden');
            renderBrowse(cards);
        } else {
            readingSection.classList.remove('hidden');
            if (mode === 'daily') {
                dailyControls.classList.remove('hidden');
                readingGrid.innerHTML = '<div class="text-center" style="grid-column:1/-1; padding:30px; color:#666;">è«‹é»æ“ŠæŒ‰éˆ•æŠ½å–ä»Šæ—¥æŒ‡å¼•ç‰Œã€‚</div>';
            } else if (mode === 'spread') {
                spreadControls.classList.remove('hidden');
                updateSpreadInfo();
                readingGrid.innerHTML = '<div class="text-center" style="grid-column:1/-1; padding:30px; color:#666;">è«‹é¸æ“‡ç‰Œé™£ä¸¦é»æ“Šé–‹å§‹æŒ‰éˆ•ã€‚</div>';
            } else if (mode === 'physical') {
                physicalControls.classList.remove('hidden');
                initPhysicalGrid();
            }
        }
    }

    // --- å¯¦é«”æŠ½ç‰Œé‚è¼¯ ---
    function initPhysicalGrid() {
        const key = document.getElementById('physicalSpreadSelect').value;
        readingGrid.innerHTML = '';
        resultActions.classList.remove('hidden');

        // æ¸…ç©ºä¹‹å‰çš„çµæœ
        if(key !== 'freeMode') currentReadingResult = [];

        if (key === 'freeMode') {
            currentReadingResult = [];
            renderFreeModeGrid();
        } else {
            // å›ºå®šç‰Œé™£æ¨¡å¼
            const spread = spreadDefinitions[key];
            currentReadingResult = new Array(spread.positions.length).fill(null);
            spread.positions.forEach((pos, index) => {
                const div = document.createElement('div');
                div.className = 'card empty-slot';
                div.id = `slot-${index}`;
                div.onclick = () => openPicker(index, pos);
                div.innerHTML = `
                    <div class="empty-icon">â•</div>
                    <div>é»æ“Šè¼¸å…¥ç‰Œå¡</div>
                    <small style="margin-top:5px; color:#b2bec3;">${pos}</small>
                `;
                readingGrid.appendChild(div);
            });
        }
    }

    // å°ˆé–€æ¸²æŸ“è‡ªç”±æ¨¡å¼çš„ Grid (ç‚ºäº†æ”¯æ´åˆªé™¤é‡æ’)
    function renderFreeModeGrid() {
        readingGrid.innerHTML = '';
        
        // æ¸²æŸ“å·²å­˜åœ¨çš„å¡ç‰‡
        currentReadingResult.forEach((item, index) => {
            // æ›´æ–°ä½ç½®æ¨™ç±¤ (å› ç‚ºå¯èƒ½ä¸­é–“è¢«åˆªé™¤äº†)
            item.position = `ç¬¬ ${index + 1} å¼µ`;
            item.index = index + 1;

            const cardEl = createCardElement(item.card, item.isUpright, item.position, 0, true);
            
            // åŠ å…¥åˆªé™¤æŒ‰éˆ•
            const delBtn = document.createElement('button');
            delBtn.className = 'card-delete-btn';
            delBtn.innerHTML = 'ğŸ—‘ï¸';
            delBtn.title = 'åˆªé™¤æ­¤ç‰Œ';
            delBtn.onclick = (e) => {
                e.stopPropagation(); // é˜»æ­¢å†’æ³¡
                removeFreeCard(index);
            };
            cardEl.appendChild(delBtn);
            
            readingGrid.appendChild(cardEl);
        });

        // æ¸²æŸ“ã€Œæ–°å¢ã€æŒ‰éˆ•
        const nextIndex = currentReadingResult.length + 1;
        const addDiv = document.createElement('div');
        addDiv.className = 'card empty-slot';
        addDiv.id = 'free-add-btn';
        addDiv.onclick = () => openPicker('free', `ç¬¬ ${nextIndex} å¼µ`);
        addDiv.innerHTML = `
            <div class="empty-icon">â•</div>
            <div>æ–°å¢ç‰Œå¡</div>
            <small style="margin-top:5px; color:#b2bec3;">(é»æ“ŠåŠ å…¥ç¬¬ ${nextIndex} å¼µ)</small>
        `;
        readingGrid.appendChild(addDiv);
    }

    function removeFreeCard(index) {
        if(confirm('ç¢ºå®šè¦åˆªé™¤é€™å¼µç‰Œå—ï¼Ÿ')) {
            currentReadingResult.splice(index, 1); // ç§»é™¤è©²å…ƒç´ 
            renderFreeModeGrid(); // é‡æ–°æ¸²æŸ“ä»¥æ›´æ–°ç·¨è™Ÿ
        }
    }

    function openPicker(index, posName) {
        pendingSlotIndex = index;
        document.getElementById('pickerTitle').innerText = `é¸æ“‡ï¼š${posName}`;
        document.getElementById('pickerReverse').checked = false;
        renderPickerGrid('all');
        pickerModal.classList.add('open');
    }

    function closePicker() {
        pickerModal.classList.remove('open');
        pendingSlotIndex = null;
    }

    function renderPickerGrid(filterType, btn) {
        if(btn) {
            document.querySelectorAll('.picker-tab').forEach(t => t.classList.remove('active'));
            btn.classList.add('active');
        }
        
        const grid = document.getElementById('pickerGrid');
        grid.innerHTML = '';
        
        const filteredCards = filterType === 'all' ? cards : cards.filter(c => c.e === filterType);
        
        filteredCards.forEach(c => {
            let elName = getElementName(c.e);
            let badgeClass = c.e;
            
            const div = document.createElement('div');
            div.className = 'picker-card';
            div.innerHTML = `
                <span class="sm-badge ${badgeClass}">${elName}</span>
                <span>${c.n}</span>
            `;
            div.onclick = () => selectPhysicalCard(c);
            grid.appendChild(div);
        });
    }

    function selectPhysicalCard(cardData) {
        const isReversed = document.getElementById('pickerReverse').checked;
        const spreadKey = document.getElementById('physicalSpreadSelect').value;
        
        if (spreadKey === 'freeMode') {
            // è‡ªç”±æ¨¡å¼ï¼šåŠ å…¥é™£åˆ—ä¸¦é‡æ–°æ¸²æŸ“æ•´å€‹ Grid
            const nextIndex = currentReadingResult.length + 1;
            const positionTitle = `ç¬¬ ${nextIndex} å¼µ`;
            
            const resultItem = { 
                card: cardData, 
                isUpright: !isReversed, 
                position: positionTitle,
                index: nextIndex 
            };
            currentReadingResult.push(resultItem);
            renderFreeModeGrid();

        } else {
            // å›ºå®šç‰Œé™£ï¼šæ›¿æ›æŒ‡å®šå¡æ§½
            const spread = spreadDefinitions[spreadKey];
            const positionTitle = spread.positions[pendingSlotIndex];
            
            const resultItem = { 
                card: cardData, 
                isUpright: !isReversed, 
                position: positionTitle,
                index: pendingSlotIndex + 1 
            };
            currentReadingResult[pendingSlotIndex] = resultItem;

            const oldSlot = document.getElementById(`slot-${pendingSlotIndex}`);
            const newCard = createCardElement(cardData, !isReversed, positionTitle, 0, true);
            newCard.id = `slot-${pendingSlotIndex}`; 
            
            readingGrid.replaceChild(newCard, oldSlot);
        }
        
        closePicker();
    }


    // --- å åœåŠŸèƒ½ (ç·šä¸Š) ---
    function drawDailyCard() {
        readingGrid.innerHTML = '<div class="text-center" style="grid-column:1/-1; padding:30px;">æ­£åœ¨æ´—ç‰Œä¸¦é€£çµèƒ½é‡...</div>';
        resultActions.classList.add('hidden');
        setTimeout(() => {
            const deck = shuffleDeck();
            const card = deck[0];
            const isUpright = Math.random() > 0.5;
            readingGrid.innerHTML = '';
            
            const cardEl = createCardElement(card, isUpright, "ä»Šæ—¥æŒ‡å¼•", 1);
            readingGrid.appendChild(cardEl);
            
            // è§¸ç™¼ç¿»ç‰Œ
            setTimeout(() => cardEl.classList.add('flipped'), 100);

            // å„²å­˜çµæœ
            currentReadingResult = [{ card: card, isUpright: isUpright, position: "ä»Šæ—¥æŒ‡å¼•", index: 1 }];
            resultActions.classList.remove('hidden');
        }, 800);
    }

    function startSpreadReading() {
        const spreadKey = document.getElementById('spreadSelect').value;
        const spread = spreadDefinitions[spreadKey];
        
        readingGrid.innerHTML = '<div class="text-center" style="grid-column:1/-1; padding:30px;">æ­£åœ¨å°ˆæ³¨æ´—ç‰Œ...</div>';
        resultActions.classList.add('hidden');
        
        setTimeout(() => {
            const deck = shuffleDeck();
            readingGrid.innerHTML = '';
            currentReadingResult = [];

            spread.positions.forEach((positionTitle, index) => {
                const card = deck[index];
                const isUpright = Math.random() > 0.5;
                
                const cardEl = createCardElement(card, isUpright, positionTitle, index + 1);
                readingGrid.appendChild(cardEl);

                // ä¾åºç¿»ç‰Œ
                setTimeout(() => cardEl.classList.add('flipped'), index * 300 + 100);

                currentReadingResult.push({ card: card, isUpright: isUpright, position: positionTitle, index: index + 1 });
            });
            resultActions.classList.remove('hidden');
        }, 1000);
    }

    // --- å»ºç«‹å¡ç‰‡ DOM ---
    function createCardElement(cardData, isUpright, positionTitle, index, noAnim = false) {
        const imgSrc = imgBaseUrl + cardData.c + ".jpg";
        let elName = getElementName(cardData.e);
        
        const statusText = isUpright ? "æ­£ä½" : "é€†ä½";
        const statusClass = isUpright ? "up" : "rev";
        const imgClass = isUpright ? "" : "rotated";
        const meaningText = isUpright ? cardData.u : cardData.r;

        const div = document.createElement('div');
        div.className = `card ${noAnim ? 'flipped no-anim' : ''}`; // å¦‚æœæ˜¯å¯¦é«”æ¨¡å¼ï¼Œç›´æ¥è¨­ç‚º flipped ä¸¦ç§»é™¤ transition
        if(!noAnim) div.style.animation = `fadeIn 0.5s ease forwards ${index * 0.1}s`;
        
        div.innerHTML = `
            <div class="content" style="padding-bottom:0;">
                <div class="position-title">${positionTitle}</div>
            </div>
            
            <div class="card-inner">
                <div class="card-back">ğŸ”®</div>
                <div class="card-front">
                    <div class="img-container">
                        <span class="badge ${cardData.e}">${elName}</span>
                        <img src="${imgSrc}" alt="${cardData.n}" class="card-img ${imgClass}" loading="lazy"
                             onerror="this.src='https://via.placeholder.com/200x350?text=Image+Error'">
                    </div>
                </div>
            </div>

            <div class="content">
                <h3>${cardData.n} <span class="reading-status ${statusClass}">(${statusText})</span></h3>
                <div class="meaning" style="font-size:1.1em; font-weight:bold;">
                    <span class="${statusClass}">${isUpright ? 'â–²' : 'â–¼'} è§£è®€ï¼š</span>
                    ${meaningText}
                </div>
                 <div class="meaning" style="margin-top:10px; font-size:0.9em; color:#888; border-top:1px dashed #eee; padding-top:10px;">
                    (åƒè€ƒï¼š${isUpright ? cardData.u : cardData.r})
                </div>
            </div>
        `;
        return div;
    }

    // --- ç€è¦½åŠŸèƒ½ ---
    function renderBrowse(data) {
        browseGrid.innerHTML = '';
        if(data.length === 0) {
            browseGrid.innerHTML = '<div style="grid-column:1/-1;text-align:center;padding:40px;color:#999;">æ‰¾ä¸åˆ°ç›¸é—œç‰Œç¾©</div>';
            return;
        }

        data.forEach(d => {
            let elName = getElementName(d.e);
            const imgSrc = imgBaseUrl + d.c + ".jpg";

            const div = document.createElement('div');
            div.className = 'card flipped no-anim'; // ç€è¦½æ¨¡å¼ç›´æ¥é¡¯ç¤ºæ­£é¢
            div.innerHTML = `
                <div class="card-inner">
                     <div class="card-front">
                        <div class="img-container">
                            <span class="badge ${d.e}">${elName}</span>
                            <img src="${imgSrc}" alt="${d.n}" class="card-img" loading="lazy">
                        </div>
                    </div>
                </div>
                <div class="content">
                    <h3>${hl(d.n)}</h3>
                    <div class="meaning">
                        <span class="label up">â–² æ­£ä½ï¼š</span>
                        <span>${hl(d.u)}</span>
                    </div>
                    <div class="meaning">
                        <span class="label rev">â–¼ é€†ä½ï¼š</span>
                        <span>${hl(d.r)}</span>
                    </div>
                </div>
            `;
            browseGrid.appendChild(div);
        });
    }

    function getElementName(e) {
        if(e === 'major') return 'å¤§ç‰Œ';
        if(e === 'fire') return 'ç«';
        if(e === 'water') return 'æ°´';
        if(e === 'air') return 'é¢¨';
        if(e === 'earth') return 'åœŸ';
        return '';
    }

    function hl(txt) {
        const v = input.value.trim();
        if(!v) return txt;
        return txt.replace(new RegExp(v, 'gi'), m => `<span class="highlight">${m}</span>`);
    }

    function filter(type, btn) {
        currentType = type;
        if(btn) {
            document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
        }
        search();
    }

    function search() {
        const v = input.value.trim().toLowerCase();
        const res = cards.filter(c => {
            if(currentType !== 'all' && c.e !== currentType) return false;
            return c.n.toLowerCase().includes(v) || c.u.includes(v) || c.r.includes(v);
        });
        renderBrowse(res);
    }

    // --- æ­·å²ç´€éŒ„åŠŸèƒ½ ---
    function saveCurrentReading() {
        if (!currentReadingResult || currentReadingResult.length === 0) {
             alert('è«‹å…ˆè¼¸å…¥è‡³å°‘ä¸€å¼µç‰Œï¼');
             return;
        }
        
        const spreadKey = (currentMode === 'physical') ? document.getElementById('physicalSpreadSelect').value : null;
        if (spreadKey && spreadKey !== 'freeMode' && currentReadingResult.some(i => i === null)) {
            alert('è«‹å¡«æ»¿æ‰€æœ‰å¡æ§½ï¼');
            return;
        }
        
        const now = new Date().toLocaleString();
        let history = JSON.parse(localStorage.getItem('tarotHistory')) || [];
        
        let spreadName = "æ¯æ—¥ä¸€æŠ½";
        let questionText = "";

        if(currentMode === 'spread') {
            spreadName = spreadDefinitions[document.getElementById('spreadSelect').value].name;
        }
        else if(currentMode === 'physical') {
            spreadName = spreadDefinitions[document.getElementById('physicalSpreadSelect').value].name + " (å¯¦é«”)";
            questionText = document.getElementById('freeQuestion').value.trim();
        }

        const record = {
            date: now,
            type: spreadName,
            question: questionText,
            cards: currentReadingResult.map(r => `${r.position}ï¼š${r.card.n} (${r.isUpright ? 'æ­£' : 'é€†'})`)
        };
        
        history.unshift(record);
        localStorage.setItem('tarotHistory', JSON.stringify(history));
        alert('âœ… çµæœå·²ä¿å­˜åˆ°æ­·å²ç´€éŒ„ï¼');
    }

    function openHistory() {
        const list = document.getElementById('historyList');
        const history = JSON.parse(localStorage.getItem('tarotHistory')) || [];
        list.innerHTML = '';
        
        if (history.length === 0) {
            list.innerHTML = '<p class="text-center">å°šç„¡ç´€éŒ„</p>';
        } else {
            history.forEach((h, index) => {
                const div = document.createElement('div');
                div.className = 'history-item';
                
                // é¡¯ç¤ºå•é¡Œ (å¦‚æœæœ‰)
                const questionHtml = h.question ? `<div class="history-question">Q: ${h.question}</div>` : '';

                div.innerHTML = `
                    <div class="history-header">
                        <span>${h.type}</span> 
                        <span style="font-weight:normal; font-size:0.8em; color:#999;">${h.date}</span>
                    </div>
                    ${questionHtml}
                    <div class="history-cards">${h.cards.join('<br>')}</div>
                    <button class="history-del-btn" onclick="deleteHistoryItem(${index})" title="åˆªé™¤æ­¤ç­†ç´€éŒ„">ğŸ—‘ï¸</button>
                `;
                list.appendChild(div);
            });
        }
        document.getElementById('historyModal').classList.add('open');
    }

    function deleteHistoryItem(index) {
        if(confirm('ç¢ºå®šè¦åˆªé™¤é€™ç­†ç´€éŒ„å—ï¼Ÿ')) {
            let history = JSON.parse(localStorage.getItem('tarotHistory')) || [];
            history.splice(index, 1); // åˆªé™¤æŒ‡å®šç´¢å¼•
            localStorage.setItem('tarotHistory', JSON.stringify(history));
            openHistory(); // é‡æ–°æ¸²æŸ“
        }
    }

    function closeHistory() {
        document.getElementById('historyModal').classList.remove('open');
    }

    function clearHistory() {
        if(confirm('ç¢ºå®šè¦æ¸…ç©ºæ‰€æœ‰ç´€éŒ„å—ï¼Ÿ')) {
            localStorage.removeItem('tarotHistory');
            openHistory();
        }
    }

    // --- AI Prompt ç”Ÿæˆ (Ultimate v3 æ›´æ–°ç‰ˆ) ---
    function generateAIPrompt() {
         if (!currentReadingResult || currentReadingResult.length === 0) {
            alert('è«‹å…ˆè¼¸å…¥è‡³å°‘ä¸€å¼µç‰Œï¼');
            return;
        }
        const spreadKey = (currentMode === 'physical') ? document.getElementById('physicalSpreadSelect').value : null;
        if (spreadKey && spreadKey !== 'freeMode' && currentReadingResult.some(i => i === null)) {
            alert('è«‹å¡«æ»¿æ‰€æœ‰å¡æ§½ï¼');
            return;
        }

        let spreadName = "ç„¡ç‰Œé™£";
        let isFreeMode = false;
        let questionText = "";

        if(currentMode === 'daily') spreadName = "å–®å¼µæŒ‡å¼•";
        else if(currentMode === 'spread') spreadName = spreadDefinitions[document.getElementById('spreadSelect').value].name;
        else if(currentMode === 'physical') {
            spreadName = spreadDefinitions[spreadKey].name;
            if(spreadKey === 'freeMode') isFreeMode = true;
            
            // æŠ“å–å•é¡Œ
            questionText = document.getElementById('freeQuestion').value.trim();
        }

        let prompt = "";
        
        // å¦‚æœæœ‰å•é¡Œï¼ŒåŠ åœ¨æœ€å‰é¢
        if (questionText) {
             prompt += `ã€æˆ‘çš„æå•ã€‘ï¼š${questionText}\n\n`;
        }

        prompt += `æˆ‘æ­£åœ¨é€²è¡Œå¡”ç¾…å åœï¼Œä½¿ç”¨ç‰Œé™£ç‚ºã€Œ${spreadName}ã€ã€‚è«‹å¹«æˆ‘ç¶œåˆè§£è®€ä»¥ä¸‹çµæœï¼š\n\n`;
        
        currentReadingResult.forEach(r => {
            if (isFreeMode) {
                // è‡ªç”±æ¨¡å¼ï¼šåªè¼¸å‡º ç‰Œå + æ­£é€†ä½ (ä¸å«è§£é‡‹)
                prompt += `- ${r.position}ï¼š${r.card.n} (${r.isUpright ? 'æ­£ä½' : 'é€†ä½'})\n`;
            } else {
                // ä¸€èˆ¬æ¨¡å¼ï¼šåŒ…å«å®Œæ•´è³‡è¨Š
                prompt += `- ${r.position}ï¼š${r.card.n} (${r.isUpright ? 'æ­£ä½' : 'é€†ä½'})\n  ç‰Œç¾©é—œéµå­—ï¼š${r.isUpright ? r.card.u : r.card.r}\n`;
            }
        });
        
        prompt += `\nè«‹é‡å°é€™å€‹å•é¡Œçµ¦å‡ºå…·é«”çš„å»ºè­°èˆ‡æŒ‡å¼•ã€‚`;

        navigator.clipboard.writeText(prompt).then(() => {
            alert('âœ… AI æŒ‡ä»¤å·²è¤‡è£½ï¼è«‹é–‹å•Ÿ ChatGPT / Gemini ä¸¦è²¼ä¸Šã€‚');
        });
    }

    // CSS Keyframe
    const styleSheet = document.createElement("style");
    styleSheet.innerText = `@keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }`;
    document.head.appendChild(styleSheet);

    input.addEventListener('input', search);
    renderBrowse(cards);

</script>
</body>
</html>
