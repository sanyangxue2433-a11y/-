<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å‚µå‹™é‚„æ¬¾è¦åŠƒåŠ©æ‰‹ v2.0</title>
    <style>
        body { font-family: "Microsoft JhengHei", sans-serif; background-color: #f4f4f9; display: flex; justify-content: center; padding: 20px; line-height: 1.6; }
        .container { background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); max-width: 800px; width: 100%; }
        h2 { text-align: center; color: #333; margin-bottom: 20px; }
        
        /* è¼¸å…¥å€åŸŸæ¨£å¼ */
        .input-section { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin-bottom: 20px; }
        .form-group { margin-bottom: 10px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; color: #555; font-size: 14px; }
        input { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; font-size: 16px; }
        
        button { width: 100%; padding: 12px; background-color: #007bff; color: white; border: none; border-radius: 6px; font-size: 16px; cursor: pointer; transition: 0.3s; margin-top: 10px; }
        button:hover { background-color: #0056b3; }
        button.export-btn { background-color: #28a745; margin-top: 10px; display: none; }
        button.export-btn:hover { background-color: #218838; }

        /* çµæœé¡¯ç¤ºå€åŸŸ */
        .result-box { margin-top: 25px; padding: 20px; background-color: #e9ecef; border-radius: 8px; display: none; }
        .summary-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px; }
        .result-item { font-size: 16px; }
        .highlight { font-weight: bold; color: #d9534f; }
        .big-text { font-size: 1.2em; color: #333; font-weight: bold; }

        /* è¦–è¦ºæ¢ */
        .progress-container { width: 100%; background-color: #ddd; border-radius: 10px; margin: 15px 0; height: 25px; position: relative; overflow: hidden; display: flex; }
        .bar-principal { background-color: #17a2b8; height: 100%; display: flex; align-items: center; justify-content: center; color: white; font-size: 12px; }
        .bar-interest { background-color: #dc3545; height: 100%; display: flex; align-items: center; justify-content: center; color: white; font-size: 12px; }

        /* è¡¨æ ¼æ¨£å¼ */
        .table-responsive { overflow-x: auto; margin-top: 20px; border-top: 2px solid #ddd; padding-top: 10px; }
        table { width: 100%; border-collapse: collapse; min-width: 500px; }
        th, td { padding: 10px; text-align: left; border-bottom: 1px solid #ddd; }
        th { background-color: #f8f9fa; color: #333; }
        tr:nth-child(even) { background-color: #f9f9f9; }

        @media (max-width: 600px) {
            .input-section { grid-template-columns: 1fr; }
            .summary-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>

<div class="container">
    <h2>ğŸ’° å‚µå‹™é‚„æ¬¾è¦åŠƒåŠ©æ‰‹ v2.0</h2>
    
    <div class="input-section">
        <div class="form-group">
            <label>ç¸½æ¬ æ¬¾ (HKD)</label>
            <input type="number" id="totalDebt" placeholder="100000">
        </div>
        <div class="form-group">
            <label>å¹´åˆ©ç‡ (%)</label>
            <input type="number" id="interestRate" placeholder="5.5" step="0.01">
        </div>
        <div class="form-group">
            <label>æ¯æœˆé‚„æ¬¾ (HKD)</label>
            <input type="number" id="monthlyPayment" placeholder="5000">
        </div>
    </div>

    <button onclick="calculateDebt()">é–‹å§‹è¨ˆç®—</button>
    <button id="exportBtn" class="export-btn" onclick="exportToCSV()">ğŸ“¥ ä¸‹è¼‰é‚„æ¬¾è¨ˆåŠƒè¡¨ (Excel/CSV)</button>

    <div id="resultBox" class="result-box">
        <div class="summary-grid">
            <div class="result-item">é‚„æ¸…æ™‚é–“ï¼š<span id="timeResult" class="highlight big-text">--</span></div>
            <div class="result-item">é è¨ˆæ—¥æœŸï¼š<span id="dateResult">--</span></div>
            <div class="result-item">ç¸½æœ¬é‡‘ï¼š<span id="principalShow">--</span></div>
            <div class="result-item">ç¸½åˆ©æ¯ï¼š<span id="interestShow" class="highlight">--</span></div>
            <div class="result-item" style="grid-column: 1 / -1;">é€£æœ¬å¸¶åˆ©ç¸½æ”¯å‡ºï¼š<span id="totalPaidShow" class="big-text">--</span></div>
        </div>

        <p style="margin-bottom: 5px; font-size: 14px; font-weight: bold;">æ”¯å‡ºçµæ§‹åˆ†æï¼š</p>
        <div class="progress-container">
            <div id="barPrincipal" class="bar-principal" style="width: 70%">æœ¬é‡‘</div>
            <div id="barInterest" class="bar-interest" style="width: 30%">åˆ©æ¯</div>
        </div>

        <div class="table-responsive">
            <h3>æ¯æœˆé‚„æ¬¾è©³ç´°è¡¨</h3>
            <table id="detailsTable">
                <thead>
                    <tr>
                        <th>æœŸæ•¸</th>
                        <th>é‚„æ¬¾é¡</th>
                        <th>å„Ÿé‚„åˆ©æ¯</th>
                        <th>å„Ÿé‚„æœ¬é‡‘</th>
                        <th>å‰©é¤˜æ¬ æ¬¾</th>
                    </tr>
                </thead>
                <tbody>
                    </tbody>
            </table>
        </div>
    </div>
</div>

<script>
    let scheduleData = []; // ç”¨æ–¼å­˜å„²æ•¸æ“šä»¥ä¾¿ä¸‹è¼‰

    window.onload = function() {
        if(localStorage.getItem('totalDebt')) document.getElementById('totalDebt').value = localStorage.getItem('totalDebt');
        if(localStorage.getItem('interestRate')) document.getElementById('interestRate').value = localStorage.getItem('interestRate');
        if(localStorage.getItem('monthlyPayment')) document.getElementById('monthlyPayment').value = localStorage.getItem('monthlyPayment');
    }

    function calculateDebt() {
        let principal = parseFloat(document.getElementById('totalDebt').value);
        let rate = parseFloat(document.getElementById('interestRate').value);
        let payment = parseFloat(document.getElementById('monthlyPayment').value);

        if (isNaN(principal) || isNaN(rate) || isNaN(payment) || principal <= 0 || payment <= 0) {
            alert("è«‹è¼¸å…¥æ­£ç¢ºçš„æ•¸å­—");
            return;
        }

        localStorage.setItem('totalDebt', principal);
        localStorage.setItem('interestRate', rate);
        localStorage.setItem('monthlyPayment', payment);

        let monthlyRate = rate / 100 / 12;
        let balance = principal;
        
        if (balance * monthlyRate >= payment) {
            alert("âš ï¸ è­¦å‘Šï¼šé‚„æ¬¾é¡ä½æ–¼åˆ©æ¯ï¼Œæ°¸é é‚„ä¸å®Œï¼è«‹å¢åŠ é‚„æ¬¾é‡‘é¡ã€‚");
            return;
        }

        scheduleData = []; // æ¸…ç©ºèˆŠæ•¸æ“š
        let totalInterest = 0;
        let months = 0;
        let tbody = document.querySelector("#detailsTable tbody");
        tbody.innerHTML = ""; // æ¸…ç©ºè¡¨æ ¼

        while (balance > 0 && months < 600) {
            months++;
            let interestForMonth = balance * monthlyRate;
            let principalForMonth = payment - interestForMonth;

            // æœ€å¾Œä¸€æœŸè™•ç†
            if (balance < principalForMonth) {
                principalForMonth = balance;
                payment = balance + interestForMonth; // æœ€å¾Œä¸€å€‹æœˆåªéœ€é‚„å‰©ä¸‹çš„
            }

            balance -= principalForMonth;
            totalInterest += interestForMonth;
            if (balance < 0.01) balance = 0;

            // å­˜å…¥æ•¸æ“š
            scheduleData.push({
                month: months,
                payment: payment.toFixed(2),
                interest: interestForMonth.toFixed(2),
                principal: principalForMonth.toFixed(2),
                balance: balance.toFixed(2)
            });

            // æ·»åŠ è¡¨æ ¼è¡Œ
            let row = `<tr>
                <td>ç¬¬ ${months} æœŸ</td>
                <td>$${payment.toFixed(2)}</td>
                <td style="color: #dc3545;">$${interestForMonth.toFixed(2)}</td>
                <td style="color: #17a2b8;">$${principalForMonth.toFixed(2)}</td>
                <td>$${balance.toFixed(2)}</td>
            </tr>`;
            tbody.innerHTML += row;
        }

        // é¡¯ç¤ºçµæœæ‘˜è¦
        let years = Math.floor(months / 12);
        let remainingMonths = months % 12;
        let timeString = (years > 0 ? years + " å¹´ " : "") + (remainingMonths > 0 ? remainingMonths + " å€‹æœˆ" : "");
        
        let today = new Date();
        today.setMonth(today.getMonth() + months);
        let finishDate = today.getFullYear() + "å¹´" + (today.getMonth() + 1) + "æœˆ";

        document.getElementById('timeResult').innerText = timeString;
        document.getElementById('dateResult').innerText = finishDate;
        document.getElementById('principalShow').innerText = "$" + principal.toFixed(2);
        document.getElementById('interestShow').innerText = "$" + totalInterest.toFixed(2);
        
        let totalPaid = principal + totalInterest;
        document.getElementById('totalPaidShow').innerText = "$" + totalPaid.toFixed(2);

        // æ›´æ–°è¦–è¦ºæ¢
        let interestPercent = (totalInterest / totalPaid) * 100;
        let principalPercent = 100 - interestPercent;
        
        document.getElementById('barPrincipal').style.width = principalPercent + "%";
        document.getElementById('barPrincipal').innerText = "æœ¬é‡‘ " + Math.round(principalPercent) + "%";
        
        document.getElementById('barInterest').style.width = interestPercent + "%";
        document.getElementById('barInterest').innerText = "åˆ©æ¯ " + Math.round(interestPercent) + "%";

        document.getElementById('resultBox').style.display = "block";
        document.getElementById('exportBtn').style.display = "block";
    }

    function exportToCSV() {
        if (scheduleData.length === 0) {
            alert("è«‹å…ˆé€²è¡Œè¨ˆç®—");
            return;
        }

        let csvContent = "\uFEFF"; // åŠ å…¥ BOM é˜²æ­¢ä¸­æ–‡äº‚ç¢¼
        csvContent += "æœŸæ•¸,é‚„æ¬¾é¡,å„Ÿé‚„åˆ©æ¯,å„Ÿé‚„æœ¬é‡‘,å‰©é¤˜æ¬ æ¬¾\n";

        scheduleData.forEach(function(row) {
            csvContent += `${row.month},${row.payment},${row.interest},${row.principal},${row.balance}\n`;
        });

        let blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
        let link = document.createElement("a");
        let url = URL.createObjectURL(blob);
        link.setAttribute("href", url);
        link.setAttribute("download", "é‚„æ¬¾è¨ˆåŠƒè¡¨.csv");
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }
</script>

</body>
</html>
