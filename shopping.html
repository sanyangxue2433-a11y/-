<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æˆ‘çš„é›²ç«¯æ”¶è—æ¸…å–®</title>
    <style>
        :root { --primary: #4a90e2; --bg: #f4f7f6; --card-bg: #ffffff; --text: #333; --green: #2ecc71; --red: #e74c3c; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: var(--bg); color: var(--text); margin: 0; padding: 20px; padding-bottom: 80px; }
        
        /* Header & Controls */
        header { max-width: 1000px; margin: 0 auto 20px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px; }
        h1 { margin: 0; font-size: 1.5rem; }
        .stats { font-size: 0.9rem; color: #666; width: 100%; margin-top: 5px;}

        .btn-group { display: flex; gap: 10px; }
        button { border: none; padding: 8px 16px; border-radius: 20px; font-size: 0.9rem; cursor: pointer; transition: transform 0.2s; color: white; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        button:hover { transform: scale(1.05); }
        .add-btn { background-color: var(--primary); font-size: 1rem; padding: 10px 20px; }
        .backup-btn { background-color: #f39c12; }
        .restore-btn { background-color: #8e44ad; }
        
        /* Grid */
        .grid-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; max-width: 1000px; margin: 0 auto; }
        
        /* Card */
        .card { background: var(--card-bg); border-radius: 12px; overflow: hidden; box-shadow: 0 2px 5px rgba(0,0,0,0.05); position: relative; border: 2px solid transparent; }
        .card.purchased { opacity: 0.7; border-color: var(--green); }
        .card.purchased::after { content: 'å·²è³¼è²·'; position: absolute; top: 10px; right: 10px; background: var(--green); color: white; padding: 2px 8px; font-size: 0.8rem; border-radius: 4px; font-weight: bold; z-index: 2; }
        
        .img-container { width: 100%; height: 200px; background-color: #eee; position: relative; cursor: pointer; }
        .card-img { width: 100%; height: 100%; object-fit: cover; display: block; }
        .img-loading { position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(255,255,255,0.8); display: none; align-items: center; justify-content: center; color: #333; }
        
        .card-body { padding: 15px; }
        .card input[type="text"], .card textarea { width: 100%; border: 1px solid #ddd; border-radius: 4px; padding: 5px; margin-bottom: 8px; box-sizing: border-box; font-family: inherit; }
        .card input.title { font-weight: bold; font-size: 1.1rem; }
        .card textarea { resize: none; height: 60px; }
        
        .actions { display: flex; justify-content: space-between; align-items: center; margin-top: 10px; }
        .delete-btn { color: var(--red); background: none; box-shadow: none; padding: 0; }
        
        #toast { position: fixed; bottom: 20px; right: 20px; background-color: #333; color: #fff; padding: 12px 24px; border-radius: 8px; opacity: 0; transition: opacity 0.3s; pointer-events: none; z-index: 1000; }
        #toast.show { opacity: 1; }
        #toast.success { background-color: var(--green); }
        #toast.error { background-color: var(--red); }
    </style>
</head>
<body>

<header>
    <div>
        <h1>ğŸ“¦ é›²ç«¯è³¼ç‰©æ¸…å–®</h1>
        <div class="stats" id="stats">è®€å–ä¸­...</div>
    </div>
    <div class="btn-group">
        <button class="backup-btn" onclick="exportData()" title="ä¸‹è¼‰å‚™ä»½æª”æ¡ˆ">â¬‡ å‚™ä»½</button>
        <button class="restore-btn" onclick="document.getElementById('import-file').click()" title="è®€å–å‚™ä»½æª”æ¡ˆ">â¬† é‚„åŸ</button>
        <button class="add-btn" onclick="addNewItem()">+ æ–°å¢</button>
    </div>
</header>

<input type="file" id="import-file" style="display:none" accept=".json" onchange="importData(this)">

<div class="grid-container" id="list"></div>
<div id="toast">æç¤ºè¨Šæ¯</div>

<script>
    const DB_NAME = 'WishlistDB_V2';
    const STORE_NAME = 'items';
    let db;

    const showToast = (msg, type = 'success') => {
        const toast = document.getElementById('toast');
        toast.innerText = msg;
        toast.className = type === 'success' ? 'success show' : 'error show';
        setTimeout(() => { toast.className = ''; }, 3000);
    };

    const initDB = () => {
        const request = indexedDB.open(DB_NAME, 1);
        request.onupgradeneeded = (e) => {
            db = e.target.result;
            if (!db.objectStoreNames.contains(STORE_NAME)) db.createObjectStore(STORE_NAME, { keyPath: 'id' });
        };
        request.onsuccess = (e) => { db = e.target.result; loadItems(); };
        request.onerror = () => showToast("è³‡æ–™åº«éŒ¯èª¤", "error");
    };

    const saveToDB = (item, silent = false) => {
        return new Promise((resolve, reject) => {
            const tx = db.transaction([STORE_NAME], 'readwrite');
            const req = tx.objectStore(STORE_NAME).put(item);
            req.onsuccess = () => { if(!silent) showToast("ğŸ’¾ å·²å„²å­˜"); updateStats(); resolve(true); };
            req.onerror = (e) => { showToast("å„²å­˜å¤±æ•—", "error"); reject(e); };
        });
    };

    const deleteItemData = (id) => {
        if(!confirm('åˆªé™¤æ­¤é …ç›®ï¼Ÿ')) return;
        const tx = db.transaction([STORE_NAME], 'readwrite');
        tx.objectStore(STORE_NAME).delete(id);
        document.getElementById(`card-${id}`).remove();
        updateStats();
    };

    const loadItems = () => {
        const tx = db.transaction([STORE_NAME], 'readonly');
        tx.objectStore(STORE_NAME).getAll().onsuccess = (e) => {
            const items = e.target.result;
            items.sort((a, b) => b.created - a.created);
            const container = document.getElementById('list');
            container.innerHTML = '';
            if (items.length === 0) for(let i=0; i<1; i++) addNewItem(false);
            else items.forEach(renderCard);
            updateStats();
        };
    };

    const updateStats = () => {
        const tx = db.transaction([STORE_NAME], 'readonly');
        tx.objectStore(STORE_NAME).getAll().onsuccess = (e) => {
            const items = e.target.result;
            const purchased = items.filter(i => i.purchased).length;
            document.getElementById('stats').innerText = `ç¸½æ•¸: ${items.length} | å·²è²·: ${purchased} | å¾…è³¼: ${items.length - purchased}`;
        };
    };

    const renderCard = (item) => {
        const container = document.getElementById('list');
        const div = document.createElement('div');
        div.className = `card ${item.purchased ? 'purchased' : ''}`;
        div.id = `card-${item.id}`;
        const imgSrc = item.image || 'https://via.placeholder.com/300x200?text=é»æ“ŠåŠ åœ–';

        div.innerHTML = `
            <input type="file" id="file-${item.id}" style="display:none" accept="image/*" onchange="handleImage('${item.id}', this)">
            <div class="img-container" onclick="document.getElementById('file-${item.id}').click()">
                <div class="img-loading" id="loading-${item.id}">è™•ç†ä¸­...</div>
                <img src="${imgSrc}" class="card-img" id="img-${item.id}">
            </div>
            <div class="card-body">
                <input type="text" class="title" value="${item.name}" placeholder="ç‰©å“åç¨±" onchange="updateField('${item.id}', 'name', this.value)">
                <input type="date" value="${item.date}" onchange="updateField('${item.id}', 'date', this.value)">
                <textarea placeholder="å‚™è¨»..." onchange="updateField('${item.id}', 'note', this.value)">${item.note}</textarea>
                <div class="actions">
                    <label style="cursor:pointer;"><input type="checkbox" ${item.purchased ? 'checked' : ''} onchange="toggleStatus('${item.id}', this.checked)"> å·²è²·</label>
                    <button class="delete-btn" onclick="deleteItemData('${item.id}')">åˆªé™¤</button>
                </div>
            </div>`;
        container.prepend(div);
    };

    const addNewItem = (shouldSave = true) => {
        const newItem = { id: Date.now().toString()+Math.random().toString(36).substr(2,5), name: '', date: new Date().toISOString().split('T')[0], note: '', purchased: false, image: null, created: Date.now() };
        if(shouldSave) saveToDB(newItem, true);
        renderCard(newItem);
    };

    const updateField = (id, field, value) => {
        const store = db.transaction([STORE_NAME], 'readwrite').objectStore(STORE_NAME);
        store.get(id).onsuccess = (e) => { const data = e.target.result; if(data){ data[field] = value; saveToDB(data); }};
    };

    const toggleStatus = (id, isChecked) => {
        document.getElementById(`card-${id}`).classList.toggle('purchased', isChecked);
        updateField(id, 'purchased', isChecked);
    };

    const handleImage = (id, input) => {
        const file = input.files[0];
        if (!file) return;
        document.getElementById(`loading-${id}`).style.display = 'flex';
        const reader = new FileReader();
        reader.onload = (e) => {
            const img = new Image();
            img.src = e.target.result;
            img.onload = () => {
                const cvs = document.createElement('canvas');
                const ctx = cvs.getContext('2d');
                const maxW = 800;
                let w = img.width, h = img.height;
                if (w > maxW) { h *= maxW / w; w = maxW; }
                cvs.width = w; cvs.height = h;
                ctx.drawImage(img, 0, 0, w, h);
                const dataUrl = cvs.toDataURL('image/jpeg', 0.6);
                const store = db.transaction([STORE_NAME], 'readwrite').objectStore(STORE_NAME);
                store.get(id).onsuccess = (ev) => {
                    const data = ev.target.result;
                    if(data) { data.image = dataUrl; store.put(data).onsuccess = () => {
                        document.getElementById(`img-${id}`).src = dataUrl;
                        document.getElementById(`loading-${id}`).style.display = 'none';
                        showToast("ğŸ“¸ ç…§ç‰‡å·²å„²å­˜");
                    };}
                };
            };
        };
        reader.readAsDataURL(file);
    };

    // --- å‚™ä»½èˆ‡é‚„åŸåŠŸèƒ½ ---
    const exportData = () => {
        const tx = db.transaction([STORE_NAME], 'readonly');
        tx.objectStore(STORE_NAME).getAll().onsuccess = (e) => {
            const data = JSON.stringify(e.target.result);
            const blob = new Blob([data], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `è³¼ç‰©æ¸…å–®å‚™ä»½_${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            showToast("å‚™ä»½æª”æ¡ˆå·²ä¸‹è¼‰");
        };
    };

    const importData = (input) => {
        const file = input.files[0];
        if(!file) return;
        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                const items = JSON.parse(e.target.result);
                if(!Array.isArray(items)) throw new Error("æ ¼å¼éŒ¯èª¤");
                if(!confirm(`ç¢ºå®šè¦åŒ¯å…¥ ${items.length} ç­†è³‡æ–™å—ï¼Ÿ\né€™å°‡æœƒåˆä½µç¾æœ‰è³‡æ–™ã€‚`)) return;
                
                const tx = db.transaction([STORE_NAME], 'readwrite');
                const store = tx.objectStore(STORE_NAME);
                let count = 0;
                items.forEach(item => {
                    store.put(item);
                    count++;
                });
                tx.oncomplete = () => {
                    alert(`æˆåŠŸåŒ¯å…¥ ${count} ç­†è³‡æ–™ï¼é é¢å°‡é‡æ–°æ•´ç†ã€‚`);
                    location.reload();
                };
            } catch(err) {
                alert("æª”æ¡ˆæ ¼å¼éŒ¯èª¤æˆ–ææ¯€");
            }
        };
        reader.readAsText(file);
        input.value = ''; // Reset
    };

    initDB();
</script>
</body>
</html>
