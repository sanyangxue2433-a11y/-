<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æˆ‘çš„é›²ç«¯æ”¶è—æ¸…å–® (ä¿®å¾©ç‰ˆ)</title>
    <style>
        :root { --primary: #4a90e2; --bg: #f4f7f6; --card-bg: #ffffff; --text: #333; --green: #2ecc71; --red: #e74c3c; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: var(--bg); color: var(--text); margin: 0; padding: 20px; padding-bottom: 80px; }
        
        header { max-width: 1000px; margin: 0 auto 20px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px; }
        h1 { margin: 0; font-size: 1.5rem; }
        .stats { font-size: 0.9rem; color: #666; width: 100%; margin-top: 5px;}

        .btn-group { display: flex; gap: 10px; flex-wrap: wrap;}
        button { border: none; padding: 8px 16px; border-radius: 20px; font-size: 0.9rem; cursor: pointer; transition: transform 0.2s; color: white; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        button:active { transform: scale(0.95); }
        .add-btn { background-color: var(--primary); font-size: 1rem; padding: 10px 20px; }
        .backup-btn { background-color: #f39c12; }
        .restore-btn { background-color: #8e44ad; }
        
        .grid-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; max-width: 1000px; margin: 0 auto; }
        
        .card { background: var(--card-bg); border-radius: 12px; overflow: hidden; box-shadow: 0 2px 5px rgba(0,0,0,0.05); position: relative; border: 2px solid transparent; }
        .card.purchased { opacity: 0.7; border-color: var(--green); }
        .card.purchased::after { content: 'å·²è³¼è²·'; position: absolute; top: 10px; right: 10px; background: var(--green); color: white; padding: 2px 8px; font-size: 0.8rem; border-radius: 4px; font-weight: bold; z-index: 2; }
        
        .img-container { width: 100%; height: 200px; background-color: #eee; position: relative; cursor: pointer; display: flex; justify-content: center; align-items: center; overflow: hidden;}
        .card-img { width: 100%; height: 100%; object-fit: cover; display: block; }
        .img-placeholder { color: #888; font-size: 0.9rem; text-align: center; padding: 20px; }
        .img-loading { position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.6); display: none; align-items: center; justify-content: center; color: #fff; font-weight: bold; z-index: 5; text-align: center; padding: 10px;}
        
        .card-body { padding: 15px; }
        .card input[type="text"], .card textarea { width: 100%; border: 1px solid #ddd; border-radius: 4px; padding: 8px; margin-bottom: 8px; box-sizing: border-box; font-family: inherit; font-size: 16px; /* é˜²æ­¢æ‰‹æ©Ÿç¸®æ”¾ */ }
        .card input.title { font-weight: bold; font-size: 1.1rem; }
        .card textarea { resize: none; height: 60px; }
        
        .actions { display: flex; justify-content: space-between; align-items: center; margin-top: 10px; }
        .delete-btn { color: var(--red); background: none; box-shadow: none; padding: 5px 10px; border: 1px solid var(--red); border-radius: 15px; color: var(--red); font-size: 0.8rem;}
        
        #toast { position: fixed; bottom: 20px; right: 20px; background-color: #333; color: #fff; padding: 12px 24px; border-radius: 8px; opacity: 0; transition: opacity 0.3s; pointer-events: none; z-index: 1000; }
        #toast.show { opacity: 1; }
        #toast.success { background-color: var(--green); }
        #toast.error { background-color: var(--red); }
    </style>
</head>
<body>

<header>
    <div>
        <h1>ğŸ“¦ é›²ç«¯æ”¶è—æ¸…å–® <small style="font-size:0.8rem; color: #888">(V3 ä¿®å¾©ç‰ˆ)</small></h1>
        <div class="stats" id="stats">è³‡æ–™åº«é€£ç·šä¸­...</div>
    </div>
    <div class="btn-group">
        <button class="backup-btn" onclick="exportData()">â¬‡ å‚™ä»½</button>
        <button class="restore-btn" onclick="document.getElementById('import-file').click()">â¬† é‚„åŸ</button>
        <button class="add-btn" onclick="addNewItem()">+ æ–°å¢</button>
    </div>
</header>

<input type="file" id="import-file" style="display:none" accept=".json" onchange="importData(this)">

<div class="grid-container" id="list"></div>
<div id="toast">æç¤ºè¨Šæ¯</div>

<script>
    // --- æ ¸å¿ƒè¨­å®š ---
    const DB_NAME = 'WishlistDB_V3'; // å‡ç´šç‰ˆæœ¬è™Ÿä»¥é‡ç½®çµæ§‹
    const STORE_NAME = 'items';
    let db;

    // æç¤ºæ¡†
    const showToast = (msg, type = 'success') => {
        const toast = document.getElementById('toast');
        toast.innerText = msg;
        toast.className = type === 'success' ? 'success show' : 'error show';
        setTimeout(() => { toast.className = ''; }, 3000);
    };

    // åˆå§‹åŒ–è³‡æ–™åº«
    const initDB = () => {
        if (!window.indexedDB) {
            alert("æ‚¨çš„ç€è¦½å™¨ä¸æ”¯æ´è³‡æ–™åº«åŠŸèƒ½ï¼Œç„¡æ³•å„²å­˜è³‡æ–™ã€‚\nè«‹è©¦è‘—ç”¨ Chrome æˆ– Safari ä¸€èˆ¬æ¨¡å¼ã€‚");
            return;
        }

        const request = indexedDB.open(DB_NAME, 1);
        
        request.onupgradeneeded = (e) => {
            db = e.target.result;
            if (!db.objectStoreNames.contains(STORE_NAME)) {
                db.createObjectStore(STORE_NAME, { keyPath: 'id' });
            }
        };

        request.onsuccess = (e) => {
            db = e.target.result;
            loadItems();
        };

        request.onerror = (e) => {
            console.error(e);
            alert("è³‡æ–™åº«æ‰“é–‹å¤±æ•—ï¼\nå¦‚æœæ‚¨ä½¿ç”¨ç„¡ç—•æ¨¡å¼(Incognito)ï¼Œè«‹åˆ‡æ›å›ä¸€èˆ¬æ¨¡å¼ã€‚");
        };
    };

    // --- è³‡æ–™æ“ä½œ ---
    const saveToDB = (item, silent = false) => {
        return new Promise((resolve, reject) => {
            if(!db) return reject("DBæœªå°±ç·’");
            const tx = db.transaction([STORE_NAME], 'readwrite');
            
            tx.oncomplete = () => {
                if(!silent) showToast("ğŸ’¾ å·²å„²å­˜");
                updateStats();
                resolve(true);
            };
            
            tx.onerror = (e) => {
                // é€™è£¡æ•æ‰é…é¡ä¸è¶³ç­‰åš´é‡éŒ¯èª¤
                const errName = e.target.error.name;
                if (errName === 'QuotaExceededError') {
                    alert("å„²å­˜å¤±æ•—ï¼šç©ºé–“å·²æ»¿ï¼\nè«‹åˆªé™¤ä¸€äº›èˆŠé …ç›®ï¼Œæˆ–å‚™ä»½å¾Œæ¸…é™¤è³‡æ–™ã€‚");
                } else {
                    console.error("Save Error:", e);
                }
                reject(e);
            };

            tx.objectStore(STORE_NAME).put(item);
        });
    };

    const deleteItemData = (id) => {
        if(!confirm('ç¢ºå®šåˆªé™¤æ­¤é …ç›®ï¼Ÿåœ–ç‰‡ä¹Ÿæœƒè¢«åˆªé™¤ã€‚')) return;
        const tx = db.transaction([STORE_NAME], 'readwrite');
        tx.objectStore(STORE_NAME).delete(id);
        tx.oncomplete = () => {
            const card = document.getElementById(`card-${id}`);
            if(card) card.remove();
            updateStats();
            showToast("é …ç›®å·²åˆªé™¤");
        };
    };

    const loadItems = () => {
        const tx = db.transaction([STORE_NAME], 'readonly');
        const store = tx.objectStore(STORE_NAME);
        const req = store.getAll();
        
        req.onsuccess = (e) => {
            const items = e.target.result;
            items.sort((a, b) => b.created - a.created);
            
            const container = document.getElementById('list');
            container.innerHTML = '';
            
            if (items.length === 0) {
                // é è¨­çµ¦ä¸€å€‹ç¯„ä¾‹
                addNewItem(false);
            } else {
                items.forEach(renderCard);
            }
            updateStats();
        };
    };

    const updateStats = () => {
        const tx = db.transaction([STORE_NAME], 'readonly');
        tx.objectStore(STORE_NAME).count().onsuccess = (e) => {
            const count = e.target.result;
            document.getElementById('stats').innerText = `ç›®å‰é …ç›®æ•¸: ${count}`;
        };
    };

    // --- ç•«é¢æ¸²æŸ“ ---
    const renderCard = (item) => {
        const container = document.getElementById('list');
        const div = document.createElement('div');
        div.className = `card ${item.purchased ? 'purchased' : ''}`;
        div.id = `card-${item.id}`;
        
        // åœ–ç‰‡é¡¯ç¤ºé‚è¼¯
        let imgDisplay = `<div class="img-placeholder">é»æ“Šä¸Šå‚³ç…§ç‰‡</div>`;
        if (item.image) {
            imgDisplay = `<img src="${item.image}" class="card-img" id="img-${item.id}">`;
        }

        div.innerHTML = `
            <input type="file" id="file-${item.id}" style="display:none" accept="image/*" onchange="handleImage('${item.id}', this)">
            <div class="img-container" onclick="document.getElementById('file-${item.id}').click()">
                <div class="img-loading" id="loading-${item.id}">è™•ç†ä¸­...</div>
                <div id="img-wrap-${item.id}" style="width:100%;height:100%">${imgDisplay}</div>
            </div>
            <div class="card-body">
                <input type="text" class="title" value="${item.name}" placeholder="ç‰©å“åç¨±" onchange="updateField('${item.id}', 'name', this.value)">
                <input type="date" value="${item.date}" onchange="updateField('${item.id}', 'date', this.value)">
                <textarea placeholder="å‚™è¨»..." onchange="updateField('${item.id}', 'note', this.value)">${item.note}</textarea>
                <div class="actions">
                    <label style="cursor:pointer;display:flex;align-items:center;">
                        <input type="checkbox" ${item.purchased ? 'checked' : ''} onchange="toggleStatus('${item.id}', this.checked)"> 
                        &nbsp;å·²è²·
                    </label>
                    <button class="delete-btn" onclick="deleteItemData('${item.id}')">åˆªé™¤</button>
                </div>
            </div>`;
        container.prepend(div);
    };

    const addNewItem = (shouldSave = true) => {
        const newItem = { 
            id: Date.now().toString() + Math.random().toString(36).substr(2,4), 
            name: '', 
            date: new Date().toISOString().split('T')[0], 
            note: '', 
            purchased: false, 
            image: null, 
            created: Date.now() 
        };
        if(shouldSave) saveToDB(newItem, true);
        renderCard(newItem);
    };

    const updateField = (id, field, value) => {
        const tx = db.transaction([STORE_NAME], 'readwrite');
        const store = tx.objectStore(STORE_NAME);
        store.get(id).onsuccess = (e) => {
            const data = e.target.result;
            if(data){ 
                data[field] = value; 
                store.put(data); 
            }
        };
    };

    const toggleStatus = (id, isChecked) => {
        const card = document.getElementById(`card-${id}`);
        if(isChecked) card.classList.add('purchased');
        else card.classList.remove('purchased');
        updateField(id, 'purchased', isChecked);
    };

    // --- é—œéµä¿®å¾©ï¼šåœ–ç‰‡è™•ç† ---
    const handleImage = (id, input) => {
        const file = input.files[0];
        if (!file) return;

        // UI ç‹€æ…‹ï¼šé¡¯ç¤ºè®€å–ä¸­
        const loadingEl = document.getElementById(`loading-${id}`);
        loadingEl.style.display = 'flex';
        loadingEl.innerText = "å£“ç¸®ä¸­...";

        const reader = new FileReader();
        
        reader.onload = (e) => {
            const img = new Image();
            img.src = e.target.result;
            
            img.onload = () => {
                try {
                    const cvs = document.createElement('canvas');
                    const ctx = cvs.getContext('2d');
                    
                    // ã€ä¿®å¾©1ã€‘æ›´åš´æ ¼çš„å°ºå¯¸é™åˆ¶ï¼Œé¿å…è¨˜æ†¶é«”çˆ†æ‰
                    const maxW = 600; 
                    let w = img.width, h = img.height;
                    
                    if (w > maxW) { 
                        h *= maxW / w; 
                        w = maxW; 
                    }
                    
                    cvs.width = w; 
                    cvs.height = h;
                    ctx.drawImage(img, 0, 0, w, h);
                    
                    // ã€ä¿®å¾©2ã€‘é™ä½å“è³ªè‡³ 0.5 ä»¥ç¯€çœç©ºé–“
                    const dataUrl = cvs.toDataURL('image/jpeg', 0.5);

                    loadingEl.innerText = "å­˜æª”ä¸­...";

                    // å¯«å…¥è³‡æ–™åº«æµç¨‹
                    const tx = db.transaction([STORE_NAME], 'readwrite');
                    const store = tx.objectStore(STORE_NAME);
                    
                    // å…ˆè®€å–èˆŠè³‡æ–™ï¼Œå†æ›´æ–°åœ–ç‰‡
                    store.get(id).onsuccess = (ev) => {
                        const data = ev.target.result;
                        if(data) {
                            data.image = dataUrl;
                            const putReq = store.put(data);

                            putReq.onsuccess = () => {
                                // æˆåŠŸå¾Œæ‰æ›´æ–°ç•«é¢
                                const imgWrap = document.getElementById(`img-wrap-${id}`);
                                imgWrap.innerHTML = `<img src="${dataUrl}" class="card-img" id="img-${id}">`;
                                loadingEl.style.display = 'none';
                                showToast("ğŸ“¸ ç…§ç‰‡å·²å„²å­˜");
                            };

                            putReq.onerror = (err) => {
                                alert("å„²å­˜å¤±æ•—ï¼ä»£ç¢¼ï¼š" + err.target.error.name);
                                loadingEl.style.display = 'none';
                            };
                        }
                    };

                    tx.onerror = (err) => {
                        const code = err.target.error.name;
                        if(code === 'QuotaExceededError'){
                            alert("âŒ å„²å­˜å¤±æ•—ï¼šå®¹é‡å·²æ»¿ã€‚\nå»ºè­°åˆªé™¤ä¸€äº›èˆŠç…§ç‰‡ã€‚");
                        } else {
                            alert("âŒ å„²å­˜å¤±æ•—ï¼šè³‡æ–™åº«éŒ¯èª¤ (" + code + ")");
                        }
                        loadingEl.style.display = 'none';
                    };

                } catch (error) {
                    alert("âŒ åœ–ç‰‡è™•ç†å¤±æ•—ï¼Œè«‹æ›ä¸€å¼µè©¦è©¦ã€‚");
                    console.error(error);
                    loadingEl.style.display = 'none';
                }
            };
            
            img.onerror = () => {
                alert("âŒ ç„¡æ³•è®€å–æ­¤åœ–ç‰‡æ ¼å¼");
                loadingEl.style.display = 'none';
            };
        };
        reader.readAsDataURL(file);
        input.value = ''; // é‡ç½® input è®“åŒä¸€å¼µåœ–å¯ä»¥å†æ¬¡é¸å–
    };

    // --- å‚™ä»½é‚„åŸ ---
    const exportData = () => {
        const tx = db.transaction([STORE_NAME], 'readonly');
        tx.objectStore(STORE_NAME).getAll().onsuccess = (e) => {
            const data = JSON.stringify(e.target.result);
            const blob = new Blob([data], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `è³¼ç‰©æ¸…å–®å‚™ä»½_${new Date().toISOString().split('T')[0]}.json`;
            a.click();
        };
    };

    const importData = (input) => {
        const file = input.files[0];
        if(!file) return;
        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                const items = JSON.parse(e.target.result);
                if(!confirm(`è¦åŒ¯å…¥ ${items.length} ç­†è³‡æ–™å—ï¼Ÿ`)) return;
                
                const tx = db.transaction([STORE_NAME], 'readwrite');
                const store = tx.objectStore(STORE_NAME);
                items.forEach(item => store.put(item));
                tx.oncomplete = () => { alert("åŒ¯å…¥æˆåŠŸï¼"); location.reload(); };
            } catch(err) { alert("æª”æ¡ˆæ ¼å¼éŒ¯èª¤"); }
        };
        reader.readAsText(file);
    };

    initDB();
</script>
</body>
</html>
